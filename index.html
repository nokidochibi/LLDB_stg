<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Love Like DataBase vol.3.1</title>
<meta name="theme-color" content="#ef4444">

<!-- ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ãŸã¨ãã®è¨­å®š -->
<meta name="apple-mobile-web-app-title" content="LLDB">
<meta name="application-name" content="LLDB">

<!-- ã‚¢ãƒ—ãƒªã‚¢ã‚¤ã‚³ãƒ³ -->
<link rel="icon" type="image/png" href="./icon.png">
<link rel="apple-touch-icon" href="./icon.png">

<!-- Web App Manifest -->
<link rel="manifest" href='data:application/manifest+json,{"name":"Love Like DataBase","short_name":"LLDB","start_url":".","display":"standalone","background_color":"#F8F8F8","theme_color":"#ef4444","icons":[{"src":"./icon.png","sizes":"192x192 512x512","type":"image/png"}]}'>

<!-- Scripts and Styles -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<style>
:root {
  --aiko-pink: #FF69B4;
  --aiko-red: #ef4444;
  --aiko-yellow: #FFD700;
  --aiko-blue: #00BFFF;
  --aiko-bg: #F8F8F8;
  --card-shadow: 0 2px 5px rgba(0,0,0,0.08);
}
* { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
  background-color: var(--aiko-bg);
  color: #374151;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
  margin: 0;
  touch-action: pan-y pinch-zoom;
  user-select: none;
  -webkit-user-select: none;
}

body.detail-view header, body.detail-view nav { display: none !important; }
body.detail-view { padding-top: 0; }

@media screen and (max-device-width: 1024px) and (orientation: landscape) {
  body.landscape header, body.landscape nav { display: none !important; }
  body.landscape { padding-top: 0; }
  body.landscape main { padding-bottom: 24px !important; }
}

.mobile-frame { width: 100%; max-width: 100%; height: 100vh; background-color: white; position: relative; overflow-y: scroll; overflow-x: hidden; }

#confetti-canvas {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 9999;
}

.card-base {
  background-color: white;
  border-radius: 12px;
  box-shadow: var(--card-shadow);
  padding: 16px;
  margin-bottom: 16px;
}

nav {
  padding-bottom: env(safe-area-inset-bottom);
  position: fixed !important;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex !important;
  border-top: 2px solid #e5e7eb;
  height: calc(64px + env(safe-area-inset-bottom));
  z-index: 50;
  width: 100%;
  background-color: white;
}
nav > div {
  display: flex;
  width: 100%;
  justify-content: space-between;
}
.tab-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  color: #9CA3AF;
  background-color: white;
  padding: 8px 0;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  flex: 1 1 0px;
  width: 0;
  height: 100%;
}
.tab-item.active { color: white; background-color: #4B5563; }
.tab-item.active i { color: white; }

/* ã‚»ãƒˆãƒªãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
.setlist-item {
  padding: 3px 0;
  margin-bottom: 0;
  background-color: transparent;
  border-bottom: 1px solid #f3f4f6;
  font-size: 16px;
  line-height: 1.4;
  display: flex;
  align-items: center;
  justify-content: space-between;
  min-height: 36px;
}
.setlist-item:last-child { border-bottom: none; }

.setlist-left-content {
  display: flex;
  align-items: baseline;
  width: 50%;
  flex: none;
  padding-right: 8px;
}

.setlist-item-number {
  display: inline-block;
  min-width: 24px;
  flex-shrink: 0;
  font-weight: normal;
  color: #9CA3AF;
  font-size: 13px;
}
.setlist-item-title {
  font-weight: 500;
  color: #1f2937;
  overflow-wrap: break-word;
}

/* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒãƒ¼ï¼ˆæ¥½æ›²è©³ç´°ç”¨ï¼‰ */
.timeline-container {
  flex: 1;
  height: 30px;
  display: flex;
  align-items: center;
  position: relative;
  padding-left: 4px;
  cursor: pointer;
}
.timeline-bar {
  width: 100%;
  height: 2px;
  background-color: #e5e7eb;
  border-radius: 2px;
  position: relative;
}
.timeline-dot {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  position: absolute;
  top: 50%;
  transform: translate(-50%, -50%);
  border: 2px solid white;
  box-shadow: 0 1px 3px rgba(0,0,0,0.15);
  background-color: var(--aiko-pink);
  z-index: 10;
  transition: transform 0.1s;
}
.year-tooltip {
  position: absolute;
  bottom: 18px;
  left: 50%;
  transform: translateX(-50%);
  background-color: #374151;
  color: white;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: bold;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
  z-index: 20;
}
.year-tooltip::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 50%;
  margin-left: -4px;
  border-width: 4px;
  border-style: solid;
  border-color: #374151 transparent transparent transparent;
}
.timeline-dot.active {
  transform: translate(-50%, -50%) scale(1.2);
}
.timeline-dot.active .year-tooltip {
  opacity: 1;
}

/* è»Œè·¡ï¼ˆå¹´è¡¨ï¼‰ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ - Vol.3.1 æ–°è¦ */
.history-grid-container {
  display: flex;
  flex-direction: column;
  width: 100%;
  border-top: 1px solid #e5e7eb;
  padding-bottom: 20px;
}
.history-grid-header {
  position: sticky;
  top: 64px; /* ã‚¢ãƒ—ãƒªãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•åˆ†ä¸‹ã’ã‚‹ */
  background-color: #f9fafb;
  z-index: 30;
  border-bottom: 1px solid #e5e7eb;
}

.history-row {
  display: grid;
  grid-template-columns: 48px 1fr 1fr 1fr; /* å¹´æœˆ, LIVE, SINGLE, ALBUM */
  min-height: 44px;
  border-bottom: 1px dashed #f3f4f6;
  position: relative;
}
/* å¹´å¤‰ã‚ã‚Šã®å¢ƒç•Œç·š */
.history-row.year-start {
  border-top: 2px solid #d1d5db;
  margin-top: -1px;
}

.col-date {
  font-size: 10px;
  font-weight: bold;
  color: #9CA3AF;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  padding-top: 6px;
  background-color: #f9fafb;
  border-right: 1px solid #e5e7eb;
  line-height: 1.2;
}
.col-date .year {
  font-size: 12px;
  color: #374151;
  font-weight: 800;
}

.col-live, .col-single, .col-album {
  position: relative;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 4px 2px;
  overflow: hidden; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã¯ã¿å‡ºãªã„ã‚ˆã†ã« */
}
.col-single, .col-album {
  border-left: 1px dashed #e5e7eb;
}

/* ãƒ„ã‚¢ãƒ¼æœŸé–“ã®ãƒ©ã‚¤ãƒ³ */
.tour-line {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  width: 6px;
  background-color: #fca5a5; /* æ·¡ã„èµ¤ */
  z-index: 0;
}
.tour-line.start {
  top: 50%;
  bottom: -1px; /* éš™é–“é˜²æ­¢ */
  border-top-left-radius: 4px;
  border-top-right-radius: 4px;
}
.tour-line.middle {
  top: -1px;
  bottom: -1px;
}
.tour-line.end {
  top: -1px;
  height: 50%; /* è¡Œã®åŠåˆ†ã¾ã§ */
  border-bottom-left-radius: 4px;
  border-bottom-right-radius: 4px;
}
/* å˜ç™ºã¾ãŸã¯åŒæœˆå†…å®Œçµã®ãƒ„ã‚¢ãƒ¼ */
.tour-dot {
  width: 10px;
  height: 10px;
  background-color: var(--aiko-red);
  border-radius: 50%;
  z-index: 1;
  box-shadow: 0 0 0 2px white;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

/* ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒƒãƒ—ï¼ˆãƒ©ãƒ™ãƒ«ï¼‰ */
.event-chip {
  font-size: 10px;
  font-weight: bold;
  padding: 3px 6px;
  border-radius: 6px;
  text-align: center;
  z-index: 2;
  width: 90%;
  max-width: 100%;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  line-height: 1.2;
  margin-bottom: 2px;
  cursor: default;
}

/* LIVEãƒãƒƒãƒ—: ãƒ„ã‚¢ãƒ¼ãƒ©ã‚¤ãƒ³ã®ä¸Šã«ä¹—ã‚‹ */
.event-chip.live {
  background-color: white;
  color: #ef4444;
  border: 1px solid #ef4444;
  cursor: pointer; /* è©³ç´°ã¸é£›ã¹ã‚‹ */
  
  /* LIVEåã¯çœç•¥è¨­å®š */
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  display: block;
}
/* ãƒ©ã‚¤ãƒ³ä¸Šã®ãƒãƒƒãƒ—ã¯å°‘ã—æµ®ã‹ã›ã‚‹ */
.tour-line + .event-chip.live {
  margin-top: 0;
}

.event-chip.single {
  background-color: #e0f2fe; /* è–„ã„é’èƒŒæ™¯ */
  color: #0284c7;
  border: 1px solid #bae6fd;
  
  /* Singleã¯æ”¹è¡Œè¨±å¯ */
  white-space: normal;
  height: auto;
  word-wrap: break-word;
}
.event-chip.album {
  background-color: #fef9c3; /* è–„ã„é»„èƒŒæ™¯ */
  color: #854d0e;
  border: 1px solid #fde047;
  
  /* Albumã‚‚æ”¹è¡Œè¨±å¯ */
  white-space: normal;
  height: auto;
  word-wrap: break-word;
}

header {
  background-color: var(--aiko-red) !important;
  color: white !important;
  height: 64px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  position: sticky;
  top: 0;
  z-index: 40;
}

main { padding: 16px; padding-bottom: calc(90px + env(safe-area-inset-bottom)); }
body.detail-view main { padding-top: 80px; padding-bottom: 40px; }

input, select { font-size: 15px !important; padding: 10px 12px !important; border-radius: 8px !important; border: 1px solid #d1d5db !important; }
button { font-size: 14px !important; }

.clickable-item { cursor: pointer; transition: background-color 0.2s; }
.clickable-item:hover { background-color: #f3f4f6; }

.action-btn {
  padding: 10px 10px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: bold;
  cursor: pointer;
  border: none;
  white-space: nowrap;
  flex-shrink: 0;
}

.clear-btn { background-color: #ef4444; color: white; }
.setlist-btn { background-color: var(--aiko-blue); color: white; }

.venue-tabs { display: flex; border-bottom: 3px solid #e5e7eb; margin-bottom: 20px; gap: 0; position: sticky; top: 0px; background: white; z-index: 40;
}
.venue-tab { flex: 1; padding: 14px; text-align: center; cursor: pointer; font-weight: 600; font-size: 15px; color: #6b7280; border-bottom: 3px solid transparent;
  margin-bottom: -3px; transition: all 0.2s; background: white; }
.venue-tab.active { color: var(--aiko-pink); border-bottom-color: var(--aiko-pink); }

/* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
.toggle-checkbox {
  position: absolute;
  opacity: 0;
  width: 0;
  height: 0;
}
.toggle-label {
  width: 48px;
  height: 24px;
  background-color: #e5e7eb;
  border-radius: 9999px;
  position: relative;
  cursor: pointer;
  transition: background-color 0.3s;
  display: block;
}
.toggle-label:before {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 20px;
  height: 20px;
  background-color: white;
  border-radius: 50%;
  transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
  box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}
.toggle-checkbox:checked + .toggle-label {
  background-color: var(--aiko-pink);
}
.toggle-checkbox:checked + .toggle-label:before {
  transform: translateX(24px);
}

.back-button-circle {
  width: 50px; height: 50px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.95);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;
  cursor: pointer; position: fixed; top: 20px; left: 20px; z-index: 1001; backdrop-filter: blur(4px); border: 1px solid #f3f4f6;
}
.back-button-circle svg { width: 28px; height: 28px; stroke: var(--aiko-red); stroke-width: 3; }

.modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: center;
  justify-content: center; padding: 20px; backdrop-filter: blur(2px); }
.modal-content { background: white; border-radius: 16px; padding: 28px; width: 100%; max-width: 440px; max-height: 80vh; overflow-y: auto; position: relative;
  box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
.modal-close { position: absolute; top: 15px; right: 15px; width: 36px; height: 36px; background: #f3f4f6; border-radius: 50%; display: flex; align-items: center;
  justify-content: center; font-size: 24px; color: #6b7280; cursor: pointer; }

.rank-number { display: inline-block; min-width: 36px; text-align: right; margin-right: 14px; flex-shrink: 0; font-size: 20px; font-weight: 800; font-style: italic; }
.song-title, .venue-name { flex: 1; word-break: break-word; font-size: 16px; font-weight: 600; line-height: 1.4; }
.song-count { white-space: nowrap; flex-shrink: 0; font-size: 18px; font-weight: bold; color: #4B5563; }
.song-count span { font-size: 13px; font-weight: normal; margin-left: 2px; }

.live-card { position: relative; overflow: hidden; padding-bottom: 16px; }
.live-card-label {
  position: absolute;
  top: 18px;
  right: -40px;
  transform: rotate(45deg);
  background-color: var(--aiko-pink);
  color: white;
  padding: 4px 0;
  width: 140px;
  text-align: center;
  font-size: 13px;
  font-weight: bold;
  box-shadow: 0 2px 4px rgba(0,0,0,0.15);
  z-index: 1;
}
.live-card-label.rock { background-color: var(--aiko-blue); }
.live-card-label.aloha { background-color: var(--aiko-yellow); color: #333; }
.live-card-label.other { background-color: #9CA3AF; }

.text-aiko-pink { color: var(--aiko-pink); }

.fade-out {
  opacity: 0;
  transition: opacity 0.5s ease-out;
  pointer-events: none;
}

/* ãŠã¿ãã˜å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.spin-once {
  animation: spin 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ãƒ€ãƒ«ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ç”¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
.tap-highlight {
    animation: highlight 0.3s ease-out;
}
@keyframes highlight {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); color: var(--aiko-pink); }
    100% { transform: scale(1); }
}
</style>
</head>
<body>
<!-- ç´™å¹é›ªç”¨ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
<canvas id="confetti-canvas"></canvas>

<div id="app" class="mobile-frame">

<header id="main-header" class="shadow-sm">
  <h1 class="font-bold text-left" style="font-size:22px; color:white; flex:1;">Love Like DataBase vol.3.1</h1>
  <button id="info-btn" style="background-color:white; color:#ef4444; padding:8px 14px; border-radius:8px; font-size:13px; font-weight:bold; border:none; cursor:pointer; flex-shrink:0; margin-left:8px;">èª­ã‚“ã§ã­</button>
</header>

<main id="main-content" style="opacity: 0; transition: opacity 0.5s;">
  <div id="live-detail" style="display:none"></div>

  <!-- å…¬æ¼”ã‚¿ãƒ– -->
  <div id="tab-search" class="tab-content" style="display:block">
    <p class="text-gray-500 mb-4 text-sm text-right">â€»<span id="last-update-date">-</span>ã¾ã§ã®æƒ…å ±ã‚’æ²è¼‰</p>
    <div class="card-base bg-gray-50 border border-gray-200">
      <div class="flex gap-1 mb-2 items-center">
        <input type="text" id="search-input" placeholder="ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢" class="flex-1 min-w-0">
        <button id="clear-all-btn" class="action-btn clear-btn">ã™ã¹ã¦ã‚¯ãƒªã‚¢</button>
      </div>

      <div class="flex flex-col gap-2 mb-2">
        <select id="tour-select" class="w-full text-gray-700 bg-white"><option value="">ã™ã¹ã¦ã®ãƒ©ã‚¤ãƒ–</option><option value="pop">Love Like Pop</option><option value="rock">Love Like Rock</option><option value="aloha">Love Like Aloha</option><option value="other">ãã®ä»–ã®ãƒ©ã‚¤ãƒ–</option></select>
        <div class="flex gap-2">
          <select id="year-select" class="flex-1 text-gray-700 bg-white"><option value="">ã™ã¹ã¦ã®å¹´</option></select>
          <select id="region-select" class="flex-1 text-gray-700 bg-white"><option value="">ã™ã¹ã¦ã®éƒ½é“åºœçœŒ</option></select>
        </div>
      </div>

      <div>
        <input type="text" id="song-filter-input" placeholder="æ¼”å¥ã•ã‚ŒãŸæ›²åã§æ¤œç´¢ï¼ˆæ¥½æ›²ã‚¿ãƒ–ã‹ã‚‰é¸æŠï¼‰" class="w-full bg-gray-100 text-gray-500" readonly>
      </div>
    </div>

    <div id="omikuji-trigger-area" class="my-6 py-2 select-none cursor-pointer text-gray-700 hover:text-gray-900 transition-colors">
      <h3 class="font-bold text-xl flex items-center gap-2">
        <span id="omikuji-icon" class="inline-block text-2xl">ğŸ«</span>
        <span class="flex-1">
          <span id="display-count-text">è¡¨ç¤ºä¸­ã®å…¬æ¼”æ•°</span>: 
          <span id="display-count">0</span> / <span id="total-count">0</span>
        </span>
      </h3>
    </div>

    <div id="live-list-container" class="space-y-4"></div>
  </div>

  <!-- æ¥½æ›²ã‚¿ãƒ– -->
  <div id="tab-song" class="tab-content" style="display:none">
    <div class="mb-8">
      <h3 class="font-bold mb-3 text-gray-700 text-xl">ğŸ“Š å¹´åˆ¥ãƒ©ã‚¤ãƒ–é–‹å‚¬ãƒ»æ¥½æ›²æ¼”å¥å›æ•°</h3>
      <p class="text-gray-500 mb-3 text-center text-sm">â€»æ¼”å¥å›æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‹ã‚‰æ›²ã‚’é¸ã¶ã¨ã€ã‚°ãƒ©ãƒ•ã«åæ˜ ã•ã‚Œã‚‹ã‚ˆ</p>
      <div class="card-base bg-white p-3">
        <canvas id="live-count-chart" style="height:250px; max-height:250px"></canvas>
      </div>
    </div>

    <div class="card-base bg-gray-50 border border-gray-200 mb-6">
      <div class="flex gap-1 mb-4 items-center">
        <input type="text" id="song-search-input" placeholder="æ¥½æ›²åã§æ¤œç´¢" class="flex-1 min-w-0">
        <button id="song-clear-btn" class="action-btn clear-btn">ã‚¯ãƒªã‚¢</button>
        <button id="show-setlist-btn" class="action-btn setlist-btn" style="display: none;">å…¬æ¼”è¡¨ç¤º</button>
      </div>
      <div class="flex justify-between items-center text-base font-semibold">
        <span class="text-gray-600">å…¨æ¥½æ›²: <span id="total-songs" class="font-bold">-</span> æ›²</span>
        <select id="song-sort" class="text-aiko-pink font-bold border-none bg-transparent" style="padding:0!important; width:auto!important; border:none!important;">
          <option value="count-desc">æ¼”å¥å›æ•° é™é †</option><option value="count-asc">æ¼”å¥å›æ•° æ˜‡é †</option>
        </select>
      </div>
    </div>

    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¦‹å‡ºã— ï¼‹ ãƒ¡ãƒ‰ãƒ¬ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒˆã‚°ãƒ« -->
    <div class="flex justify-between items-center mt-8 mb-4">
      <h3 id="song-ranking-header" class="font-bold text-gray-700 text-xl cursor-pointer select-none">
        <span id="song-ranking-icon" class="inline-block">ğŸ¸</span> æ¼”å¥å›æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°
      </h3>
      <div class="flex items-center gap-2">
        <span class="text-xs font-bold text-gray-500">ãƒ¡ãƒ‰ãƒ¬ãƒ¼<br>è¾¼ã¿</span>
        <div class="relative inline-block align-middle select-none">
            <input type="checkbox" name="toggle" id="medley-toggle" class="toggle-checkbox" checked/>
            <label for="medley-toggle" class="toggle-label"></label>
        </div>
      </div>
    </div>
    
    <div id="song-ranking-container"></div>
  </div>

  <!-- å ´æ‰€ã‚¿ãƒ– -->
  <div id="tab-venue" class="tab-content" style="display:none">
    <div class="mb-8">
      <h3 class="font-bold mb-3 text-gray-700 text-xl">ğŸ“Š å¹´åˆ¥ãƒ©ã‚¤ãƒ–é–‹å‚¬å›æ•°</h3>
      <p class="text-gray-500 mb-3 text-center text-sm">â€»ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‹ã‚‰ä¼šå ´/éƒ½é“åºœçœŒã‚’é¸ã¶ã¨ã€ã‚°ãƒ©ãƒ•ã«åæ˜ ã•ã‚Œã‚‹ã‚ˆ</p>
      <div class="card-base bg-white p-3">
        <canvas id="venue-live-count-chart" style="height:250px; max-height:250px"></canvas>
      </div>
    </div>
    <div class="card-base bg-gray-50 border border-gray-200 mb-0 rounded-b-none">
      <div class="flex gap-1 items-center">
        <input type="text" id="venue-search-input" placeholder="ä¼šå ´ ã¾ãŸã¯ éƒ½é“åºœçœŒåã§æ¤œç´¢" class="flex-1 min-w-0">
        <button id="venue-clear-btn" class="action-btn clear-btn">ã‚¯ãƒªã‚¢</button>
        <button id="venue-show-setlist-btn" class="action-btn setlist-btn" style="display: none;">å…¬æ¼”è¡¨ç¤º</button>
      </div>
    </div>
    <div class="venue-tabs">
      <div class="venue-tab active" data-venue-tab="venue" id="venue-tab-header">ä¼šå ´ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
      <div class="venue-tab" data-venue-tab="region" id="region-tab-header">éƒ½é“åºœçœŒãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
    </div>
    <div id="venue-ranking-container" class="mt-4"></div>
    <div id="region-ranking-container" class="mt-4" style="display:none"></div>
  </div>
  
  <!-- å‚¾å‘ã‚¿ãƒ– -->
  <div id="tab-pattern" class="tab-content" style="display:none">
    <div class="mb-8">
      <h3 class="font-bold mb-3 text-gray-700 text-xl">ğŸ“Š ã‚¢ãƒ«ãƒãƒ åˆ¥æ¼”å¥å›æ•°</h3>
      <div class="card-base bg-white p-3">
        <canvas id="album-chart" style="height:350px; max-height:350px"></canvas>
      </div>
    </div>

    <div class="mb-8"><h3 class="font-bold mb-3 text-gray-700 text-xl">ğŸ•°ï¸ æœ€è¿‘æ¼”å¥ã•ã‚Œã¦ã„ãªã„æ›² TOP 10</h3>
    <p class="text-gray-500 mb-3 text-center text-sm">â€»éå»ã«1åº¦ã§ã‚‚æ¼”å¥ã•ã‚ŒãŸæ›²ãŒå¯¾è±¡ã ã‚ˆ</p>
    <div id="not-played-recently-songs" class="card-base bg-white p-2"></div></div>

    <div class="mb-8"><h3 class="font-bold mb-3 text-gray-700 text-xl">ğŸ¬ ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°æ›² TOP 10</h3>
    <div id="opening-songs" class="card-base bg-white p-2"></div></div>
    <div class="mb-8"><h3 class="font-bold mb-3 text-gray-700 text-xl">ğŸ‘ ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«æ›² TOP 10</h3>
    <div id="encore-songs" class="card-base bg-white p-2"></div></div>
    <div class="mb-8"><h3 class="font-bold mb-3 text-gray-700 text-xl">ğŸ å¤§ãƒˆãƒªæ›² TOP 10</h3>
    <div id="last-songs" class="card-base bg-white p-2"></div></div>
  </div>

  <!-- è»Œè·¡ï¼ˆæ­´å²ï¼‰ã‚¿ãƒ–ï¼šãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ« -->
  <div id="tab-history" class="tab-content" style="display:none">
    <div class="mb-4 px-1">
      <h3 class="font-bold text-gray-700 text-xl">â³ 1998å¹´ã‹ã‚‰ã®è»Œè·¡</h3>
      <p class="text-gray-500 text-sm mt-1">ãƒ©ã‚¤ãƒ–ã€ã‚·ãƒ³ã‚°ãƒ«ã€ã‚¢ãƒ«ãƒãƒ ã®æ­´å²</p>
    </div>
    
    <div class="history-grid-header flex text-[10px] font-bold text-gray-400 pb-1 mb-0">
      <div style="width:48px; text-align:center;">å¹´æœˆ</div>
      <div class="flex-1 text-center">LIVE</div>
      <div class="flex-1 text-center border-l border-dashed border-gray-200">SINGLE</div>
      <div class="flex-1 text-center border-l border-dashed border-gray-200">ALBUM</div>
    </div>
    <div id="history-grid-container" class="history-grid-container bg-white">
        <!-- JSã§ç”Ÿæˆ -->
    </div>
    
    <div class="text-center mt-8 mb-4 text-gray-400 text-sm">
      <p>ã€œ ç¾åœ¨ ã€œ</p>
    </div>
  </div>

</main>

<div id="loading-container" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#0f172a; z-index:9000; display:flex; align-items:center; justify-content:center;">
  <div class="text-center py-20 font-bold select-none overflow-hidden" style="color: white; text-shadow: 0 0 15px white;">
    <p class="m-0 transition-opacity duration-300" style="font-size:42px; line-height:1.2;">
      <span id="loading-text-1" class="opacity-0">ç”·å­ãƒ¼!!</span> <span id="loading-text-2" class="opacity-0">å¥³å­ãƒ¼!!</span>
    </p>
    <p class="m-0 transition-opacity duration-300" style="font-size:42px; line-height:1.2;">
      <span id="loading-text-3" class="opacity-0">ãã†ã§ãªã„äººãƒ¼!!</span>
    </p>
    <p class="m-0 transition-opacity duration-300" style="font-size:56px; line-height:1.2; margin-top:16px;">
      <span id="loading-text-4" class="opacity-0">ãœãƒ¼</span><span id="loading-text-5" class="opacity-0">ã„ã‚“ã£...!!!</span>
    </p>
  </div>
</div>

<div id="modal-overlay" class="modal-overlay" style="display:none">
  <div class="modal-content">
    <span class="modal-close" onclick="closeModal()">&times;</span>
    <div id="modal-body"></div>
  </div>
</div>

<div id="info-modal" class="modal-overlay" style="display:none">
  <div class="modal-content">
    <span class="modal-close" onclick="closeInfoModal()">&times;</span>
    <div class="text-base leading-relaxed text-gray-700">
      <h3 class="font-bold text-lg mb-3 text-aiko-red">â–¼æƒ…å ±æº</h3>
      <ul class="list-disc pl-5 mb-6 space-y-2">
        <li>ã“ã®ã‚¢ãƒ—ãƒªã®æƒ…å ±ã¯é–‹ç™ºè€…ãŒç‹¬è‡ªã®èª¿æŸ»ã§é›†ç´„ã—ãŸã‚‚ã®ã ã‚ˆã€‚</li>
        <li>ã‚¢ã‚«ãƒšãƒ©ã§æ­Œã£ãŸæ›²ãŒå…¥ã£ã¦ã„ã‚‹ãªã©ã€ä¸€éƒ¨ã‚»ãƒˆãƒªãƒœãƒ¼ãƒ‰ã¨ç•°ãªã‚‹å ´åˆãŒã‚ã‚‹ã‚ˆã€‚</li>
        <li>ã¾ã¡ãŒã£ã¦ã„ã‚‹æƒ…å ±ãªã©ãŒã‚ã‚Œã°ã€ãœã²Xï¼ˆTwitterï¼‰ã®<a href="https://twitter.com/noki_dochibi" target="_blank" class="text-blue-500 underline">@noki_dochibi</a>ã¾ã§ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚</li>
        <li>ãƒ†ãƒ¬ãƒ“ç•ªçµ„/éŸ³æ¥½ç‰¹ç•ªã®æƒ…å ±ã¯ãªãã€ãƒ©ã‚¤ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã¨æ€ã‚ã‚Œã‚‹ï¼‰æƒ…å ±ã®ã¿è¼‰ã›ã¦ã„ã‚‹ã‚ˆã€‚</li>
      </ul>
      <h3 class="font-bold text-lg mb-3 text-aiko-red">â–¼é›†è¨ˆæ–¹æ³•</h3>
      <ul class="list-disc pl-5 mb-6 space-y-2">
        <li>ã€ã‚ˆã‚Šé“ã€ã€ç›¸åˆå‚˜ã€ãªã©ãƒãƒ¼ã‚¸ãƒ§ãƒ³é•ã„ãŒã‚ã‚‹ã‚‚ã®ã‚‚ã€ï¼‘ã¤ã®æ›²ã¨ã—ã¦çµ±åˆã—ã¦ã„ã‚‹ã‚ˆã€‚</li>
        <li>ã€Œãƒ¡ãƒ‰ãƒ¬ãƒ¼ã€ã¯è¤‡æ•°ã®æ›²ã‚’ã¾ã¨ã‚ã¦ï¼‘æ›²ã¨ã—ã¦æ‰±ã£ã¦ã„ã‚‹ã‚ˆã€‚</li>
        <li>å³èˆˆæ›²ãªã©ã¯å«ã‚“ã§ã„ãªã„ã‚ˆã€‚</li>
        <li><span class="font-bold text-aiko-red">ã€Œå‚¾å‘ã€ã‚¿ãƒ–ã®é›†è¨ˆï¼ˆã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã€å¤§ãƒˆãƒªãªã©ï¼‰ã§ã¯ã€ãƒ¡ãƒ‰ãƒ¬ãƒ¼å†…ã®æ›²ã¯å¯¾è±¡å¤–ã¨ã—ã¦ã„ã‚‹ã‚ˆã€‚</span></li>
        <li>ä¼šå ´ã¯ã€åŒã˜å»ºç‰©ã§åç§°ãŒå¤‰ã‚ã£ãŸã‚‚ã®ã¯ã€Œæ—§åç§° / æ–°åç§°ã€ã¨ã—ã¦ã„ã‚‹ã‚ˆã€‚åŒã˜å ´æ‰€ã§ã‚‚å»ºã¦æ›¿ãˆãŸæ–°ã—ã„å»ºç‰©ã®å ´åˆã¯ã€åˆ¥ã®ä¼šå ´ã¨ã—ã¦ã„ã‚‹ã‚ˆã€‚</li>
      </ul>
      <h3 class="font-bold text-lg mb-3 text-aiko-red">â–¼æ“ä½œ</h3>
      <ul class="list-disc pl-5 mb-6 space-y-2">
        <li>ã‚»ãƒˆãƒªã®ãƒšãƒ¼ã‚¸ã®å·¦ä¸Šã«ã€Œâ†ï¼ˆæˆ»ã‚‹ï¼‰ã€ãƒœã‚¿ãƒ³ãŒã‚ã‚‹ã‘ã©ã€ãƒ©ã‚¤ãƒ–åã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚‚å‰ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹ã‚ˆã€‚å³æ‰‹ã§ã‚‚æŠ¼ã—ã‚„ã™ã„ã­ã€‚</li>
        <li>ã©ã“ã‹ã®ã€Œè¦‹å‡ºã—ã€ã‚’ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€ä½•ã‹ãŒãƒ©ãƒ³ãƒ€ãƒ ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã€‚</li>
        <li>ã‚»ãƒˆãƒªç”»é¢ã®ã€ŒğŸµ ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã€ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ã‚³ãƒ”ãƒ¼ã§ãã‚‹ã‚ˆã€‚</li>
      </ul>
      
      <!-- æœ€æ–°ã®ãŠçŸ¥ã‚‰ã›ã‚¨ãƒªã‚¢ï¼ˆã“ã“ã ã‘è¡¨ç¤ºã™ã‚‹é‹ç”¨ï¼‰ -->
      <h3 class="font-bold text-lg mb-3 text-aiko-red">ğŸ”” æœ€æ–°ã®ãŠçŸ¥ã‚‰ã› (vol.3.1)</h3>
      <div class="bg-gray-50 p-3 rounded-lg border border-gray-100 mb-6 text-sm text-gray-600">
        <p>ã€Œè»Œè·¡ã€ã‚¿ãƒ–ã‚’ãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«ï¼å¹´è¡¨å½¢å¼ã§ãƒ„ã‚¢ãƒ¼ã®æœŸé–“ã‚„ãƒªãƒªãƒ¼ã‚¹ã®æ­´å²ãŒè¦‹ã‚„ã™ããªã‚Šã¾ã—ãŸã€‚</p>
      </div>

      <h3 class="font-bold text-lg mb-3 text-aiko-red">â–¼ãã®ä»–</h3>
      <p>ä»–ã«ã‚‚ã„ã‚ã„ã‚ãŠã‚‚ã¡ã‚ƒãŒã‚ã‚‹ã‚ˆ<br>â†’<a href="https://lit.link/nokidochibi" target="_blank" class="text-blue-500 underline">https://lit.link/nokidochibi</a></p>
    </div>
  </div>
</div>

<!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<nav class="bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
  <div class="flex w-full">
    <a href="#" class="tab-item active" data-tab="search">
      <i data-lucide="calendar-days" style="width:26px;height:26px"></i>
      <span class="text-[11px] font-bold">å…¬æ¼”</span>
    </a>
    <a href="#" class="tab-item" data-tab="song">
      <i data-lucide="music" style="width:26px;height:26px"></i>
      <span class="text-[11px] font-bold">æ¥½æ›²</span>
    </a>
    <a href="#" class="tab-item" data-tab="venue">
      <i data-lucide="map-pin" style="width:26px;height:26px"></i>
      <span class="text-[11px] font-bold">å ´æ‰€</span>
    </a>
    <a href="#" class="tab-item" data-tab="pattern">
      <i data-lucide="shuffle" style="width:26px;height:26px"></i>
      <span class="text-[11px] font-bold">å‚¾å‘</span>
    </a>
    <a href="#" class="tab-item" data-tab="history">
      <i data-lucide="footprints" style="width:26px;height:26px"></i>
      <span class="text-[11px] font-bold">è»Œè·¡</span>
    </a>
  </div>
</nav>

</div>

<script>
// GASã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®stgç’°å¢ƒURLï¼‰
const API_URL = "https://script.google.com/macros/s/AKfycbxDCVXoHkQcs1FjMc5o9wA7KyjwQM5OnDweXEaee-tMb_AeGncibSHU4BEazCDmEBT1dA/exec";
// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ (æ›´æ–°ã—ã¦å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ + ãƒ•ãƒªãƒ¼ã‚ºå¯¾ç­–)
const CACHE_KEY = 'lldb_data_v3_9_fix7'; 

// ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–Promise
let appInitializedResolver;
const appInitializedPromise = new Promise(resolve => {
  appInitializedResolver = resolve;
});

// ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†Promise
let animationFinishedResolver;
const animationFinishedPromise = new Promise(resolve => {
  animationFinishedResolver = resolve;
});

document.addEventListener('DOMContentLoaded', () => {
  lucide.createIcons();
  setupRandomTriggers();

  // 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª
  const cachedData = localStorage.getItem(CACHE_KEY);
  let isCachedLoaded = false;

  if (cachedData) {
    try {
      const parsed = JSON.parse(cachedData);
      if (parsed.liveRecords && parsed.liveRecords.length > 0) {
        initializeApp(parsed);
        appInitializedResolver(); 
        isCachedLoaded = true;
      }
    } catch (e) {
      console.error("Cache parse error", e);
    }
  }

  // 2. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹
  startLoadingAnimation(isCachedLoaded ? 'fast' : 'normal');

  // 3. ãƒ‡ãƒ¼ã‚¿å–å¾—
  loadAllData(isCachedLoaded);

  Promise.all([appInitializedPromise, animationFinishedPromise]).then(() => {
    finishLoading();
  });
});

let allLiveRecords = [], 
    songStats = {},            
    songStatsNoMedley = {},    
    patternStats = {}, 
    lastPlayedStats = {}, 
    albumData = [], 
    songData = {}, 
    historyData = [], 
    chartInstances = {};
let selectedVenueInfo = null;
let currentDisplayingRecord = null;

// å®‰å…¨ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ï¼ˆå®¹é‡ã‚¨ãƒ©ãƒ¼å¯¾ç­–ï¼‰
function saveToCache(data) {
  try {
    localStorage.setItem(CACHE_KEY, JSON.stringify(data));
  } catch (e) {
    console.warn("Cache save failed:", e);
    // å®¹é‡ã‚¨ãƒ©ãƒ¼(QuotaExceededError)ã®å ´åˆã€å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ¶ˆã—ã¦å†ãƒˆãƒ©ã‚¤
    if (e.name === 'QuotaExceededError' || e.message.includes('quota')) {
       console.log("Clearing old cache...");
       localStorage.clear(); // å…¨å‰Šé™¤ã—ã¦å†ãƒˆãƒ©ã‚¤
       try {
         localStorage.setItem(CACHE_KEY, JSON.stringify(data));
       } catch (e2) {
         console.error("Retry failed. App will run without cache.", e2);
         // ãã‚Œã§ã‚‚ãƒ€ãƒ¡ãªã‚‰ä¿å­˜ã‚’è«¦ã‚ã‚‹ãŒã€ã‚¢ãƒ—ãƒªã¯æ­¢ã‚ãªã„
       }
    }
  }
}

// ä¸€æ‹¬ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼†ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
async function loadAllData(isAlreadyDisplayed) {
  try {
    const response = await fetch(`${API_URL}?action=getAllData`);
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    const data = await response.json();

    if (data.status === 'error') {
        throw new Error(data.message);
    }

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ï¼ˆå¤±æ•—ã—ã¦ã‚‚ã‚¢ãƒ—ãƒªã¯å‹•ã‹ã™ï¼‰
    saveToCache(data);

    try {
        initializeApp(data);
    } catch(e) {
        throw new Error("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: " + e.message);
    }

    if (!isAlreadyDisplayed) {
      appInitializedResolver();
    }
  } catch (error) {
    if (!isAlreadyDisplayed) {
      // è‡´å‘½çš„ãªå–å¾—ã‚¨ãƒ©ãƒ¼ã®å ´åˆã®ã¿ã‚¨ãƒ©ãƒ¼ç”»é¢ã¸
      handleError(error); 
      appInitializedResolver();
    } else {
      console.log("Background update failed, keeping cached data.");
    }
  }
}

function startLoadingAnimation(mode) {
  let loadingTexts;
  let totalDuration;

  if (mode === 'fast') {
    loadingTexts = [
        { id: 'loading-text-1', delay: 0 },
        { id: 'loading-text-2', delay: 500 },
        { id: 'loading-text-3', delay: 1000 },
        { id: 'loading-text-4', delay: 1500 },
        { id: 'loading-text-5', delay: 2000 }
    ];
    totalDuration = 2500;
  } else {
    loadingTexts = [
        { id: 'loading-text-1', delay: 100 },
        { id: 'loading-text-2', delay: 900 },
        { id: 'loading-text-3', delay: 1700 },
        { id: 'loading-text-4', delay: 2500 },
        { id: 'loading-text-5', delay: 3000 }
    ];
    totalDuration = 3800;
  }

  loadingTexts.forEach(item => {
    setTimeout(() => {
      const element = document.getElementById(item.id);
      if (element) element.classList.remove('opacity-0');
    }, item.delay);
  });

  setTimeout(() => {
    animationFinishedResolver();
  }, totalDuration);
}

function finishLoading() {
  startConfetti();
  const loadingDiv = document.getElementById('loading-container');
  loadingDiv.classList.add('fade-out');
  document.getElementById('main-content').style.opacity = '1';
  setTimeout(() => {
    loadingDiv.style.display = 'none';
  }, 500);
}

function initializeApp(data) {
  allLiveRecords = data.liveRecords || [];
  albumData = data.albumData || [];
  songData = data.songData || {};
  historyData = data.historyData || []; 

  if (allLiveRecords.length > 0) {
    try {
        const latestDate = allLiveRecords.reduce((latest, rec) => {
          const d = new Date(rec.date);
          return d > latest ? d : latest;
        }, new Date(0));
        
        if (!isNaN(latestDate.getTime())) {
            document.getElementById('last-update-date').textContent = `${latestDate.getFullYear()}/${('0' + (latestDate.getMonth() + 1)).slice(-2)}/${('0' + latestDate.getDate()).slice(-2)}`;
        }
    } catch(e) { console.error(e); }
  }

  analyzeSongStats(allLiveRecords);
  analyzePatterns(allLiveRecords);
  analyzeLastPlayed(allLiveRecords);
  populateFilters(allLiveRecords);
  
  if (historyData.length > 0) {
      renderHistoryTab();
  }

  if (!document.getElementById('search-input').hasAttribute('data-listener-attached')) {
    setupEventListeners();
    document.getElementById('search-input').setAttribute('data-listener-attached', 'true');
  }

  applyFilters();
  checkOrientation();
  window.addEventListener('resize', checkOrientation);

  renderLiveCountChart();
  renderAlbumChart();
  renderSongRanking(); 
  renderPatternStats();
  renderLastPlayedRanking();
  renderVenueRanking();
  renderVenueLiveCountChart();
}

// -----------------------------------------------------------
// è»Œè·¡ï¼ˆæ­´å²ï¼‰ã‚¿ãƒ–ã®ãƒ­ã‚¸ãƒƒã‚¯ (Vol.3.1 ãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«ç‰ˆ)
// -----------------------------------------------------------
function formatTourName(name) {
  if (!name) return "";
  let n = name;
  
  // ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆã€œã€~ ä»¥é™ï¼‰ã‚’ã‚«ãƒƒãƒˆ
  n = n.split(/[ã€œ~]/)[0];
  
  // åŸºæœ¬çš„ãªç½®æ›
  if (n.match(/Love Like (Pop|Rock|Aloha)/i)) {
      n = n.replace(/Love Like /i, '');
      n = n.replace(/ vol\.?/i, ''); // vol. ã¾ãŸã¯ vol
      n = n.replace(/è¿½åŠ å…¬æ¼”/g, ''); // è¿½åŠ å…¬æ¼”ã®æ–‡å­—ã¯æ¶ˆã™
      n = n.trim();
      
      // Pop12.5 ãªã©ã®ã‚±ãƒ¼ã‚¹ã‚‚è€ƒæ…®
      n = n.replace(/\s+/g, '');
  }
  return n.trim();
}

function renderHistoryTab() {
    const container = document.getElementById('history-grid-container');
    if (!container) return;

    // 1. å…¨æœŸé–“ã®è¨ˆç®—ã¨ãƒ„ã‚¢ãƒ¼æœŸé–“ã®ç‰¹å®š
    if (historyData.length === 0) return;

    let minDate = new Date();
    let maxDate = new Date(0);
    const tourRanges = {}; // { "Pop3": { startYm: '1999/12', endYm: '2000/02' } }

    historyData.forEach(event => {
        // æ—¥ä»˜è§£æ
        if (!event.date) return;
        const d = new Date(event.date);
        if (d < minDate) minDate = d;
        if (d > maxDate) maxDate = d;

        // ãƒ„ã‚¢ãƒ¼æƒ…å ±ã®è“„ç© (LIVEã®ã¿)
        if (event.type === 'live') {
            const shortName = formatTourName(event.title);
            const ym = `${d.getFullYear()}/${('0' + (d.getMonth() + 1)).slice(-2)}`;
            
            // Pop, Rock, Aloha ã‚·ãƒªãƒ¼ã‚ºã®ã¿ã‚’æœŸé–“ã¨ã—ã¦æ‰±ã†ï¼ˆãã‚Œä»¥å¤–ã¯å˜ç™ºï¼‰
            if (shortName.match(/^(Pop|Rock|Aloha)/)) {
                if (!tourRanges[shortName]) {
                    tourRanges[shortName] = { start: ym, end: ym };
                } else {
                    if (ym < tourRanges[shortName].start) tourRanges[shortName].start = ym;
                    if (ym > tourRanges[shortName].end) tourRanges[shortName].end = ym;
                }
            }
        }
    });

    // 2. æœˆã”ã¨ã®ãƒ‡ãƒ¼ã‚¿æ§‹ç¯‰
    const timelineData = {}; // { 'YYYY/MM': { live: [], single: [], album: [] } }
    
    // minDateã‹ã‚‰maxDateã¾ã§æœˆã”ã¨ã«åŸ‹ã‚ã‚‹
    let current = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
    const end = new Date(maxDate.getFullYear(), maxDate.getMonth(), 1);

    while (current <= end) {
        const ym = `${current.getFullYear()}/${('0' + (current.getMonth() + 1)).slice(-2)}`;
        timelineData[ym] = { live: [], single: [], album: [], isTourActive: false, tourType: '', tourId: '' };
        current.setMonth(current.getMonth() + 1);
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆã‚’å„æœˆã«æŒ¯ã‚Šåˆ†ã‘
    historyData.forEach(event => {
        if (!event.date) return;

        // é™¤å¤–å¯¾è±¡ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        if (event.title === 'æ·±å¤œ2æ™‚ã€Œå¯’ã„ã­ã€ã£ã¦å½¼ã¨ã‚¹ãƒ¼ãƒ‘ãƒ¼è¡Œã£ãŸã˜ã‚ƒã‚“ã€‚') return;

        // ã‚¢ãƒ«ãƒãƒ åã®æ­£è¦åŒ–ï¼ˆã¾ã¨ã‚ï¼‘ã€ã¾ã¨ã‚ï¼’ â†’ ã¾ã¨ã‚ï¼‰
        let title = event.title;
        if (event.type === 'album' && title.startsWith('ã¾ã¨ã‚')) {
            title = 'ã¾ã¨ã‚';
        }

        const d = new Date(event.date);
        const ym = `${d.getFullYear()}/${('0' + (d.getMonth() + 1)).slice(-2)}`;
        if (timelineData[ym]) {
            if (event.type === 'live') {
                const shortName = formatTourName(event.title);
                // é‡è¤‡æ’é™¤ (åŒæœˆã«åŒã˜ãƒ„ã‚¢ãƒ¼ãŒè¤‡æ•°å›ã‚ã£ã¦ã‚‚1ã¤è¡¨ç¤º)
                if (!timelineData[ym].live.some(e => e.name === shortName)) {
                    timelineData[ym].live.push({ 
                        name: shortName, 
                        rawName: event.title,
                        rawDate: event.date // æ¤œç´¢ç”¨
                    });
                }
            } else if (event.type === 'single') {
                // ã‚·ãƒ³ã‚°ãƒ«ã¯åŒæœˆå†…ã§æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ã™ã‚‹ãŸã‚ã«ã€è©³ç´°ãªæ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚ä¿å­˜ã—ã¦ãŠã
                timelineData[ym].single.push({ name: title, dateObj: d });
            } else if (event.type === 'album') {
                // åŒã˜æœˆã«ã€Œã¾ã¨ã‚1ã€ã€Œã¾ã¨ã‚2ã€ãŒã‚ã‚‹å ´åˆã€ã€Œã¾ã¨ã‚ã€ãŒ2ã¤ã«ãªã‚‰ãªã„ã‚ˆã†ã«é‡è¤‡ãƒã‚§ãƒƒã‚¯
                if (!timelineData[ym].album.some(a => a.name === title)) {
                    timelineData[ym].album.push({ name: title });
                }
            }
        }
    });

    // 3. HTMLç”Ÿæˆ
    let html = '';
    const sortedKeys = Object.keys(timelineData).sort();
    let lastYear = null;

    sortedKeys.forEach(ym => {
        const [year, month] = ym.split('/');
        const data = timelineData[ym];
        
        // ãƒ„ã‚¢ãƒ¼æœŸé–“åˆ¤å®š
        let tourLineClass = '';
        let activeTourId = null;

        // è¤‡æ•°ã®ãƒ„ã‚¢ãƒ¼ãŒè¢«ã‚‹å¯èƒ½æ€§ã¯ä½ã„å‰æã§ã€æœ€åˆã«è¦‹ã¤ã‹ã£ãŸãƒ„ã‚¢ãƒ¼ã‚’æ¡ç”¨
        for (const [id, range] of Object.entries(tourRanges)) {
            if (ym >= range.start && ym <= range.end) {
                activeTourId = id;
                if (range.start === range.end) {
                    // åŒæœˆå®Œçµï¼ˆå˜ç™ºæ‰±ã„ï¼ãƒ‰ãƒƒãƒˆï¼‰
                    tourLineClass = 'dot'; 
                } else if (ym === range.start) {
                    tourLineClass = 'start';
                } else if (ym === range.end) {
                    tourLineClass = 'end';
                } else {
                    tourLineClass = 'middle';
                }
                break;
            }
        }

        // å¹´æ›¿ã‚ã‚Šã®å¢ƒç•Œç·šã‚¯ãƒ©ã‚¹
        const rowClass = (year !== lastYear) ? 'year-start' : '';
        const displayYear = (year !== lastYear) ? year : '';
        lastYear = year;

        // LIVEåˆ—ã®ç”Ÿæˆ
        let liveHtml = '';
        if (activeTourId && tourLineClass && tourLineClass !== 'dot') {
            liveHtml += `<div class="tour-line ${tourLineClass}"></div>`;
        }
        
        // ãã®æœˆã«ãƒ©ã‚¤ãƒ–ãŒã‚ã‚Œã°ãƒãƒƒãƒ—ã‚’è¡¨ç¤º
        if (data.live.length > 0) {
            data.live.forEach(l => {
                // ãƒ„ã‚¢ãƒ¼æœŸé–“ä¸­ã§ã€ã‹ã¤ãã®ãƒãƒƒãƒ—ãŒãƒ„ã‚¢ãƒ¼åã¨ä¸€è‡´ã™ã‚‹å ´åˆã¯ãƒ©ã‚¤ãƒ³ä¸Šã«é…ç½®
                const isTourLive = activeTourId && l.name === activeTourId;
                
                // å˜ç™ºã®å ´åˆã®ãƒ‰ãƒƒãƒˆè¡¨ç¤ºï¼ˆãƒ„ã‚¢ãƒ¼ãƒ©ã‚¤ãƒ³ãŒãªã„å ´åˆã®ã¿ï¼‰
                if (!activeTourId && l.name.match(/^(Pop|Rock|Aloha)/)) {
                     liveHtml += `<div class="tour-dot"></div>`;
                }

                const safeName = l.rawName.replace(/'/g, "\\'");
                const safeDate = l.rawDate;
                liveHtml += `<div class="event-chip live" onclick="findAndShowLive('${safeDate}', '${safeName}')">${l.name}</div>`;
            });
        }

        // SINGLEåˆ—: åŒæœˆã‹ã¤åŒæ—¥ç™ºå£²ã¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥åŒºåˆ‡ã‚Šã§ã¾ã¨ã‚ã‚‹
        let singleHtml = '';
        if (data.single.length > 0) {
            // æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°
            const groupedByDate = {};
            data.single.forEach(s => {
                const dateKey = s.dateObj.getDate(); // æ—¥ä»˜ã ã‘å–å¾—
                if (!groupedByDate[dateKey]) groupedByDate[dateKey] = [];
                groupedByDate[dateKey].push(s.name);
            });
            
            // ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ãƒãƒƒãƒ—ç”Ÿæˆ
            Object.keys(groupedByDate).sort((a,b) => a - b).forEach(d => {
                 const combinedName = groupedByDate[d].join('/');
                 singleHtml += `<div class="event-chip single">${combinedName}</div>`;
            });
        }

        // ALBUMåˆ—
        let albumHtml = data.album.map(a => `<div class="event-chip album">${a.name}</div>`).join('');

        html += `
        <div class="history-row ${rowClass}">
            <div class="col-date">
                ${displayYear ? `<span class="year">${displayYear}</span>` : ''}
                <span class="month">${Number(month)}æœˆ</span>
            </div>
            <div class="col-live">
                ${liveHtml}
            </div>
            <div class="col-single">
                ${singleHtml}
            </div>
            <div class="col-album">
                ${albumHtml}
            </div>
        </div>
        `;
    });

    container.innerHTML = html;
}

window.findAndShowLive = function(dateStr, tourName) {
    document.getElementById('search-input').value = tourName;
    document.getElementById('tour-select').value = '';
    document.getElementById('year-select').value = '';
    document.getElementById('region-select').value = '';
    document.getElementById('song-filter-input').value = '';
    switchToTab('search');
    applyFilters();
}

// -----------------------------------------------------------
// ãã®ä»–
// -----------------------------------------------------------
function setupRandomTriggers() {
  function createDoubleTapHandler(callback) {
    let tapCount = 0;
    let timer = null;
    return (e) => {
      e.preventDefault();
      e.stopPropagation(); 
      tapCount++;
      if (timer) clearTimeout(timer);
      timer = setTimeout(() => { tapCount = 0; }, 500); 
      
      if (tapCount >= 2) {
        tapCount = 0;
        clearTimeout(timer);
        const target = e.currentTarget;
        target.classList.remove('tap-highlight');
        void target.offsetWidth;
        target.classList.add('tap-highlight');
        callback();
      }
    };
  }

  const omikujiArea = document.getElementById('omikuji-trigger-area');
  if (omikujiArea) {
    omikujiArea.addEventListener('click', createDoubleTapHandler(() => {
        playOmikuji();
    }));
  }

  const songHeader = document.getElementById('song-ranking-header');
  if (songHeader) {
    songHeader.addEventListener('click', createDoubleTapHandler(() => {
        const icon = document.getElementById('song-ranking-icon');
        if (icon) {
            icon.classList.remove('spin-once');
            void icon.offsetWidth; 
            icon.classList.add('spin-once');
        }
        const songs = Object.keys(songStats);
        if (songs.length === 0) return;
        const randomSong = songs[Math.floor(Math.random() * songs.length)];
        setTimeout(() => {
            selectSong(randomSong);
            document.getElementById('song-ranking-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 600);
    }));
  }

  const venueHeader = document.getElementById('venue-tab-header');
  if (venueHeader) {
    venueHeader.addEventListener('click', createDoubleTapHandler(() => {
        if (!venueHeader.classList.contains('active')) return;
        const venues = [];
        allLiveRecords.forEach(rec => {
             const v = rec.region === 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' ? 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' : `${rec.venue} (${rec.region})`;
             if (!venues.includes(v)) venues.push(v);
        });
        if (venues.length === 0) return;
        const randomVenue = venues[Math.floor(Math.random() * venues.length)];
        selectVenue(randomVenue);
    }));
  }

  const regionHeader = document.getElementById('region-tab-header');
  if (regionHeader) {
     regionHeader.addEventListener('click', createDoubleTapHandler(() => {
        if (!regionHeader.classList.contains('active')) return;
        const regions = [];
        allLiveRecords.forEach(rec => {
            if (rec.region && !regions.includes(rec.region)) regions.push(rec.region);
        });
        if (regions.length === 0) return;
        const randomRegion = regions[Math.floor(Math.random() * regions.length)];
        selectRegion(randomRegion);
     }));
  }
}

function playOmikuji() {
    const icon = document.getElementById('omikuji-icon');
    icon.classList.remove('spin-once');
    void icon.offsetWidth; 
    icon.classList.add('spin-once');

    const randomLive = allLiveRecords[Math.floor(Math.random() * allLiveRecords.length)];
    setTimeout(() => {
        showOmikujiResult(randomLive);
    }, 600);
}

function showOmikujiResult(rec) {
    const tourNameLower = rec.tourName.toLowerCase();
    let labelType = 'other', labelText = 'ãã®ä»–';
    if (tourNameLower.includes('love like pop')) { labelType = 'pop'; labelText = 'POP'; }
    else if (tourNameLower.includes('love like rock')) { labelType = 'rock'; labelText = 'ROCK'; }
    else if (tourNameLower.includes('love like aloha')) { labelType = 'aloha'; labelText = 'ALOHA'; }

    const cardHtml = `
      <div class="card-base live-card cursor-pointer shadow-md" onclick="closeModal(); showLiveDetail(allLiveRecords.find(r => r.date === '${rec.date}' && r.tourName === '${rec.tourName}'))">
        <div class="live-card-label ${labelType}">${labelText}</div>
        <p class="text-gray-500 font-medium text-xs">${rec.date} (${rec.dayOfWeek})</p>
        <p class="font-bold mt-1 text-gray-800 text-lg leading-tight">${rec.tourName}</p>
        <p class="text-gray-600 text-sm mt-1">${rec.venue} (${rec.region})</p>
        <p class="mt-2 font-semibold text-aiko-pink text-sm">ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ: ${rec.songCount}æ›²</p>
      </div>
      <p class="text-center text-gray-400 text-xs mt-2">ğŸ‘† ã‚¿ãƒƒãƒ—ã§è©³ç´°ã¸</p>
    `;

    document.getElementById('modal-body').innerHTML = `
        <h2 class="font-bold text-center text-xl mb-4 text-aiko-pink">ä»Šæ—¥ã®ãƒ©ãƒƒã‚­ãƒ¼ã‚»ãƒˆãƒªğŸ¤</h2>
        ${cardHtml}
    `;
    document.getElementById('modal-overlay').style.display = 'flex';
}

function startConfetti() {
  const canvas = document.getElementById('confetti-canvas');
  const ctx = canvas.getContext('2d');
  let width = window.innerWidth;
  let height = window.innerHeight;
  canvas.width = width;
  canvas.height = height;

  const particles = [];
  const particleCount = 400;
  const colors = ['#FFD700', '#C0C0C0', '#FF69B4', '#ef4444', '#FFA500'];

  class Particle {
    constructor() {
      this.x = width / 2;
      this.y = height / 2;
      this.color = colors[Math.floor(Math.random() * colors.length)];
      this.w = Math.random() * 10 + 5;
      this.h = Math.random() * 4 + 2;
      const angle = Math.random() * Math.PI * 2;
      const velocity = Math.random() * 15 + 8;
      this.vx = Math.cos(angle) * velocity;
      this.vy = Math.sin(angle) * velocity - 5;
      this.gravity = 0.35;
      this.friction = 0.95;
      this.rotation = Math.random() * 360;
      this.rotationSpeed = (Math.random() - 0.5) * 15;
      this.alpha = 1;
    }
    update() {
      this.vx *= this.friction;
      this.vy *= this.friction;
      this.vy += this.gravity;
      this.x += this.vx;
      this.y += this.vy;
      this.rotation += this.rotationSpeed;
      if (this.y > height + 20) this.alpha = 0;
    }
    draw(ctx) {
      if (this.alpha <= 0) return;
      ctx.save();
      ctx.translate(this.x, this.y);
      ctx.rotate((this.rotation * Math.PI) / 180);
      ctx.fillStyle = this.color;
      ctx.fillRect(-this.w / 2, -this.h / 2, this.w, this.h);
      ctx.restore();
    }
  }
  for (let i = 0; i < particleCount; i++) {
    particles.push(new Particle());
  }
  function animate() {
    ctx.clearRect(0, 0, width, height);
    let activeParticles = 0;
    particles.forEach(p => {
      p.update();
      p.draw(ctx);
      if (p.y < height + 50) activeParticles++;
    });
    if (activeParticles > 0) {
      requestAnimationFrame(animate);
    } else {
      ctx.clearRect(0, 0, width, height);
    }
  }
  animate();
  window.addEventListener('resize', () => {
    width = window.innerWidth;
    height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;
  });
}

function checkOrientation() {
  if ('ontouchend' in document && window.innerWidth > window.innerHeight) {
    document.body.classList.add('landscape');
  } else {
    document.body.classList.remove('landscape');
  }
}

const chartCommonOptions = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: { legend: { display: false } },
  scales: {
    x: { ticks: { font: { size: 10 } } },
    y: { ticks: { font: { size: 10 } } }
  }
};

function renderAlbumChart() {
  const canvas = document.getElementById('album-chart');
  if (!canvas || !albumData.length) return;
  if (chartInstances.album) {
    chartInstances.album.destroy();
    chartInstances.album = null;
  }
  chartInstances.album = new Chart(canvas, {
    type: 'bar',
    data: {
      labels: albumData.map(item => item.albumName),
      datasets: [{
        label: 'æ¼”å¥å›æ•°',
        data: albumData.map(item => item.playCount),
        backgroundColor: 'rgba(255, 105, 180, 0.8)',
        borderColor: 'rgba(255, 105, 180, 1)',
        borderWidth: 1,
        borderRadius: 4
      }]
    },
    options: {
      ...chartCommonOptions,
      indexAxis: 'y',
      plugins: {
        legend: { display: false },
        datalabels: {
          color: 'white',
          anchor: 'end',
          align: 'start',
          offset: 4,
          font: { weight: 'bold', size: 11 },
          formatter: (value) => value > 0 ? value : ''
        }
      },
      scales: {
        x: { beginAtZero: true, ticks: { font: { size: 10 } } },
        y: { ticks: { font: { size: 10 }, autoSkip: false } }
      }
    },
    plugins: [ChartDataLabels]
  });
}

function renderLiveCountChart() {
  const canvas = document.getElementById('live-count-chart');
  if (!canvas) return;
  if (chartInstances.liveCount) chartInstances.liveCount.destroy();

  const liveCountsByYear = allLiveRecords.reduce((acc, rec) => {
    if (rec.year) acc[rec.year] = (acc[rec.year] || 0) + 1;
    return acc;
  }, {});

  const songToSearch = document.getElementById('song-search-input').value.trim();
  const isMedleyIncluded = document.getElementById('medley-toggle').checked;

  const songPlaysByYear = {};
  if (songToSearch) {
    allLiveRecords.forEach(rec => {
      if (!rec.year) return;
      
      let inMedley = false;
      let count = 0;

      rec.setlist.forEach(s => {
        if (s === '__MEDLEY_START__') { inMedley = true; return; }
        if (s === '__MEDLEY_END__') { inMedley = false; return; }
        
        // ãƒ¡ãƒ‰ãƒ¬ãƒ¼é™¤å¤–è¨­å®šã§ã€ã‹ã¤ç¾åœ¨ãƒ¡ãƒ‰ãƒ¬ãƒ¼ä¸­ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
        if (!isMedleyIncluded && inMedley) return;

        const clean = s.replace(/_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«/g, '').replace(/#\d+$/g, '').trim();
        if (clean.toLowerCase() === songToSearch.toLowerCase()) {
            count++;
        }
      });

      if (count > 0) songPlaysByYear[rec.year] = (songPlaysByYear[rec.year] || 0) + count;
    });
  }

  const years = Object.keys(liveCountsByYear).sort((a, b) => a - b);
  const totalLiveData = years.map(year => liveCountsByYear[year]);
  const songPlayData = years.map(year => songPlaysByYear[year] || 0);

  const datasets = [{
    label: 'æ¥½æ›²æ¼”å¥',
    data: songPlayData,
    backgroundColor: 'rgba(255, 105, 180, 0.8)',
    borderColor: 'rgba(255, 105, 180, 1)',
    borderWidth: 1,
    stack: 'stack1',
    datalabels: {
      display: ctx => ctx.dataset.data[ctx.dataIndex] > 0,
      color: 'gray',
      anchor: 'end',
      align: 'end',
      offset: -2,
      font: { size: 10, weight: 'bold' },
      formatter: val => val
    }
  }, {
    label: 'ãã®ä»–',
    data: totalLiveData.map((total, i) => Math.max(0, total - songPlayData[i])),
    backgroundColor: 'rgba(229, 231, 235, 0.8)',
    borderColor: 'rgba(229, 231, 235, 1)',
    borderWidth: 1,
    stack: 'stack1',
    datalabels: { display: false }
  }];

  chartInstances.liveCount = new Chart(canvas, {
    type: 'bar',
    data: { labels: years, datasets },
    plugins: [ChartDataLabels],
    options: {
      ...chartCommonOptions,
      scales: {
        x: {
          stacked: true,
          ticks: { font: { size: 10 }, maxRotation: 90, minRotation: 90, autoSkip: false }
        },
        y: { stacked: true, beginAtZero: true, min: 0, ticks: { font: { size: 10 }, stepSize: 5 } }
      }
    }
  });
}

function renderVenueLiveCountChart() {
  const canvas = document.getElementById('venue-live-count-chart');
  if (!canvas) return;
  if (chartInstances.venueLiveCount) chartInstances.venueLiveCount.destroy();

  const liveCountsByYear = allLiveRecords.reduce((acc, rec) => {
    if (rec.year) acc[rec.year] = (acc[rec.year] || 0) + 1;
    return acc;
  }, {});

  const selectedPlaysByYear = {};
  if (selectedVenueInfo) {
    allLiveRecords.forEach(rec => {
      if (!rec.year) return;
      let isMatch = false;
      if (selectedVenueInfo.type === 'venue') {
        const venueKey = rec.region === 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' ? 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' : `${rec.venue} (${rec.region})`;
        if (venueKey === selectedVenueInfo.name) isMatch = true;
      } else if (selectedVenueInfo.type === 'region') {
        if (rec.region === selectedVenueInfo.name) isMatch = true;
      }
      if (isMatch) selectedPlaysByYear[rec.year] = (selectedPlaysByYear[rec.year] || 0) + 1;
    });
  }

  const years = Object.keys(liveCountsByYear).sort((a, b) => a - b);
  const totalLiveData = years.map(year => liveCountsByYear[year]);
  const selectedPlayData = years.map(year => selectedPlaysByYear[year] || 0);

  const datasets = [{
    label: 'é¸æŠå ´æ‰€',
    data: selectedPlayData,
    backgroundColor: 'rgba(255, 105, 180, 0.8)',
    borderColor: 'rgba(255, 105, 180, 1)',
    borderWidth: 1,
    stack: 'stack1',
    datalabels: {
      display: ctx => ctx.dataset.data[ctx.dataIndex] > 0,
      color: 'gray',
      anchor: 'end',
      align: 'end',
      offset: -2,
      font: { size: 10, weight: 'bold' },
      formatter: val => val
    }
  }, {
    label: 'ãã®ä»–',
    data: totalLiveData.map((total, i) => Math.max(0, total - selectedPlayData[i])),
    backgroundColor: 'rgba(229, 231, 235, 0.8)',
    borderColor: 'rgba(229, 231, 235, 1)',
    borderWidth: 1,
    stack: 'stack1',
    datalabels: { display: false }
  }];

  chartInstances.venueLiveCount = new Chart(canvas, {
    type: 'bar',
    data: { labels: years, datasets },
    plugins: [ChartDataLabels],
    options: {
      ...chartCommonOptions,
      scales: {
        x: {
          stacked: true,
          ticks: { font: { size: 10 }, maxRotation: 90, minRotation: 90, autoSkip: false }
        },
        y: { stacked: true, beginAtZero: true, min: 0, ticks: { font: { size: 10 }, stepSize: 5 } }
      }
    }
  });
}

function analyzeSongStats(records) {
  songStats = {};
  songStatsNoMedley = {};

  // æ¥½æ›²ãƒ‡ãƒ¼ã‚¿ã«ã‚ã‚‹å…¨æ›²ã‚’0å›ã§åˆæœŸåŒ–
  if (songData) {
    Object.keys(songData).forEach(songName => {
      // ã‚«ã‚®ã‚«ãƒƒã‚³ä»˜ãï¼ˆã‚«ãƒãƒ¼æ›²ãªã©ï¼‰ã¯åˆæœŸåŒ–ã‚‚ã—ãªã„ï¼ˆé™¤å¤–ï¼‰
      if (!songName.includes('[') && !songName.includes(']')) {
          songStats[songName] = 0;
          songStatsNoMedley[songName] = 0;
      }
    });
  }

  records.forEach(rec => {
    let inMedley = false;
    rec.setlist.forEach(s => {
      if (s === '__MEDLEY_START__') { inMedley = true; return; }
      if (s === '__MEDLEY_END__') { inMedley = false; return; }

      const clean = s.replace(/_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«/g, '').replace(/#\d+$/g, '').trim();
      
      // é™¤å¤–åˆ¤å®š: ãƒ¡ãƒ‰ãƒ¬ãƒ¼æ–‡å­—ã€ã¾ãŸã¯ [] ã‚’å«ã‚€æ›²
      if (clean && clean !== 'ãƒ¡ãƒ‰ãƒ¬ãƒ¼' && !clean.includes('[') && !clean.includes(']')) {
        // å…¨é›†è¨ˆï¼ˆãƒ¡ãƒ‰ãƒ¬ãƒ¼è¾¼ã¿ï¼‰
        songStats[clean] = (songStats[clean] || 0) + 1;
        // ãƒ¡ãƒ‰ãƒ¬ãƒ¼é™¤å¤–é›†è¨ˆ
        if (!inMedley) {
            songStatsNoMedley[clean] = (songStatsNoMedley[clean] || 0) + 1;
        }
      }
    });
  });
}

function analyzePatterns(records) {
  const o = {}, e = {}, l = {};
  records.forEach(rec => {
    // ãƒ¡ãƒ‰ãƒ¬ãƒ¼åŒºé–“ã‚’å®Œå…¨ã«é™¤å¤–ã—ã¦ãƒªã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹
    const cleanSetlist = [];
    let inMedley = false;
    
    rec.setlist.forEach(s => {
        if (s === '__MEDLEY_START__') { inMedley = true; return; }
        if (s === '__MEDLEY_END__') { inMedley = false; return; }
        
        if (inMedley) return; // ãƒ¡ãƒ‰ãƒ¬ãƒ¼ä¸­ã¯ç„¡è¦–

        const clean = s.replace(/_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«/g, '').replace(/#\d+$/g, '').trim();
        // é™¤å¤–åˆ¤å®š: ãƒ¡ãƒ‰ãƒ¬ãƒ¼æ–‡å­—ã€ã¾ãŸã¯ [] ã‚’å«ã‚€æ›²
        if (clean && clean !== 'ãƒ¡ãƒ‰ãƒ¬ãƒ¼' && !clean.includes('[') && !clean.includes(']')) {
            cleanSetlist.push(clean);
        }
    });

    if (cleanSetlist.length > 0) {
        o[cleanSetlist[0]] = (o[cleanSetlist[0]] || 0) + 1;
        l[cleanSetlist[cleanSetlist.length - 1]] = (l[cleanSetlist[cleanSetlist.length - 1]] || 0) + 1;
    }

    // ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«é›†è¨ˆï¼ˆã“ã“ã‚‚ãƒ¡ãƒ‰ãƒ¬ãƒ¼å†…ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«ã¯é™¤å¤–ï¼‰
    let inMedleyForEncore = false;
    rec.setlist.forEach(s => {
        if (s === '__MEDLEY_START__') { inMedleyForEncore = true; return; }
        if (s === '__MEDLEY_END__') { inMedleyForEncore = false; return; }
        if (inMedleyForEncore) return;
        
        if (s.includes('_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«')) {
            const clean = s.replace(/_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«/g, '').replace(/#\d+$/g, '').trim();
            if (clean && clean !== 'ãƒ¡ãƒ‰ãƒ¬ãƒ¼' && !clean.includes('[') && !clean.includes(']')) {
                e[clean] = (e[clean] || 0) + 1;
            }
        }
    });
  });
  patternStats = { openingSongs: o, encoreSongs: e, lastSongs: l };
}

function analyzeLastPlayed(records) {
  lastPlayedStats = {};
  records.forEach(rec => {
    const recDate = new Date(rec.date);
    
    rec.setlist.forEach(s => {
      if (s.startsWith('__MEDLEY_') || s === 'ãƒ¡ãƒ‰ãƒ¬ãƒ¼') return;
      
      const cleanName = s.replace(/_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«(?: #\d+)?/g, '').trim();
      if (!cleanName) return;
      // ã‚«ã‚®ã‚«ãƒƒã‚³ä»˜ãã‚’é™¤å¤–
      if (cleanName.includes('[') || cleanName.includes(']')) return;
      if (!songData[cleanName]) return;

      if (!lastPlayedStats[cleanName] || recDate > lastPlayedStats[cleanName].dateObj) {
        lastPlayedStats[cleanName] = {
          dateObj: recDate,
          tourName: rec.tourName,
          year: rec.year
        };
      }
    });
  });
}

function renderLastPlayedRanking() {
  const container = document.getElementById('not-played-recently-songs');
  if (!container) return;

  const sorted = Object.entries(lastPlayedStats)
    .sort((a, b) => a[1].dateObj - b[1].dateObj)
    .slice(0, 10);

  container.innerHTML = sorted.map(([song, data], i) => {
    const rankColor = i < 3 ? ['text-aiko-pink','text-aiko-yellow','text-aiko-blue'][i] : 'text-gray-300';
    const borderClass = i !== sorted.length - 1 ? 'border-b border-gray-100' : '';
    
    return `<div class="p-3 clickable-item flex items-center ${borderClass}" onclick="selectSong('${song.replace(/'/g, "\\'")}')">
      <span class="rank-number ${rankColor}">${i + 1}</span>
      <div class="flex-1 min-w-0">
        <div class="song-title text-gray-700 truncate">${song}</div>
        <div class="text-xs text-gray-400 mt-0.5 truncate">(${data.year}) ${data.tourName}</div>
      </div>
    </div>`;
  }).join('');
}

function populateFilters(records, skipApply = false) {
  const yearSelect = document.getElementById('year-select');
  const regionSelect = document.getElementById('region-select');
  const years = new Set(), regions = new Set();
  records.forEach(rec => {
    if (rec.year) years.add(rec.year);
    if (rec.region) regions.add(rec.region);
  });

  const createOptions = (select, current, data, suffix) => {
    select.innerHTML = `<option value="">ã™ã¹ã¦ã®${suffix}</option>`;
    data.forEach(item => {
      select.innerHTML += `<option value="${item}" ${item == current ? 'selected' : ''}>${item}${suffix === 'å¹´' ? 'å¹´' : ''}</option>`;
    });
  };

  createOptions(yearSelect, yearSelect.value, Array.from(years).sort((a, b) => b - a), 'å¹´');
  createOptions(regionSelect, regionSelect.value, Array.from(regions).sort(), 'éƒ½é“åºœçœŒ');
  if (!skipApply) applyFilters();
}

function applyFilters() {
  const songFilterInput = document.getElementById('song-filter-input');
  let songFilterValue = songFilterInput.value;
  if (songFilterInput.value.includes('ï¼ˆæ¥½æ›²ã‚¿ãƒ–ã‹ã‚‰é¸æŠï¼‰')) {
    songFilterValue = songFilterValue.replace('ï¼ˆæ¥½æ›²ã‚¿ãƒ–ã‹ã‚‰é¸æŠï¼‰', '');
  }

  const filters = {
    search: document.getElementById('search-input').value.toLowerCase(),
    tour: document.getElementById('tour-select').value,
    year: document.getElementById('year-select').value,
    region: document.getElementById('region-select').value,
    song: songFilterValue.toLowerCase(),
  };

  const filteredRecords = allLiveRecords.filter(rec => {
    const tourName = rec.tourName.toLowerCase();
    let tourMatch = true;
    if (filters.tour === 'pop') tourMatch = tourName.includes('love like pop');
    else if (filters.tour === 'rock') tourMatch = tourName.includes('love like rock');
    else if (filters.tour === 'aloha') tourMatch = tourName.includes('love like aloha');
    else if (filters.tour === 'other') tourMatch = !/love like (pop|rock|aloha)/.test(tourName);

    const songMatch = !filters.song || rec.setlist.some(s => s.replace(/_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«/g, '').replace(/#\d+$/g, '').trim().toLowerCase() === filters.song);
    const searchMatch = !filters.search || (rec.tourName + ' ' + rec.date + ' ' + rec.venue + ' ' + rec.region).toLowerCase().includes(filters.search);

    return tourMatch && songMatch && searchMatch &&
      (!filters.year || rec.year == filters.year) &&
      (!filters.region || rec.region == filters.region);
  });

  document.getElementById('display-count').textContent = filteredRecords.length;
  document.getElementById('total-count').textContent = allLiveRecords.length;
  renderLiveList(filteredRecords);
}

function renderLiveList(records) {
  const container = document.getElementById('live-list-container');
  container.innerHTML = '';
  if (!records.length) {
    container.innerHTML = '<p class="text-center text-gray-500 py-8 text-sm">è©²å½“ã™ã‚‹å…¬æ¼”ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
    return;
  }

  records.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(rec => {
    const tourNameLower = rec.tourName.toLowerCase();
    let labelType = 'other', labelText = 'ãã®ä»–';
    if (tourNameLower.includes('love like pop')) { labelType = 'pop'; labelText = 'POP'; }
    else if (tourNameLower.includes('love like rock')) { labelType = 'rock'; labelText = 'ROCK'; }
    else if (tourNameLower.includes('love like aloha')) { labelType = 'aloha'; labelText = 'ALOHA'; }

    const card = document.createElement('div');
    card.className = 'card-base live-card cursor-pointer hover:shadow-md transition';
    card.innerHTML = `
      <div class="live-card-label ${labelType}">${labelText}</div>
      <p class="text-gray-500 font-medium text-xs">${rec.date} (${rec.dayOfWeek})</p>
      <p class="font-bold mt-1 text-gray-800 text-lg leading-tight">${rec.tourName}</p>
      <p class="text-gray-600 text-sm mt-1">${rec.venue} (${rec.region})</p>
      <p class="mt-2 font-semibold text-aiko-pink text-sm">ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ: ${rec.songCount}æ›²</p>`;
    card.onclick = () => showLiveDetail(rec);
    container.appendChild(card);
  });
}

function showLiveDetail(rec) {
  document.body.classList.add('detail-view');
  currentDisplayingRecord = rec;

  document.querySelectorAll('.tab-content, #main-header, nav').forEach(el => el.style.display = 'none');

  let backBtn = document.getElementById('back-button-fixed');
  if (!backBtn) {
    backBtn = document.createElement('div');
    backBtn.id = 'back-button-fixed';
    backBtn.className = 'back-button-circle';
    backBtn.innerHTML = '<i data-lucide="arrow-left"></i>';
    document.body.appendChild(backBtn);
    lucide.createIcons();
    backBtn.onclick = hideDetailView;
  }
  backBtn.style.display = 'flex';

  const detailContainer = document.getElementById('live-detail');
  detailContainer.style.display = 'block';

  const minYear = 1998;
  const maxYear = new Date().getFullYear();

  function normalizeType(rawType) {
    if (!rawType) return 'ãã®ä»–';
    if (rawType.includes('è¡¨é¡Œ') || rawType.includes('ã‚·ãƒ³ã‚°ãƒ«')) return 'è¡¨é¡Œæ›²';
    if (rawType.includes('ã‚«ãƒƒãƒ—ãƒªãƒ³ã‚°') || rawType.includes('C/W') || rawType.includes('Bé¢')) return 'ã‚«ãƒƒãƒ—ãƒªãƒ³ã‚°æ›²';
    if (rawType.includes('ã‚¢ãƒ«ãƒãƒ ') || rawType.includes('Album')) return 'ã‚¢ãƒ«ãƒãƒ æ›²';
    return 'ãã®ä»–';
  }

  function createTimelineHtml(songName) {
    const songInfo = songData[songName];
    if (!songInfo || !songInfo.year) return ''; 
    
    const songYear = songInfo.year;
    let percent = ((songYear - minYear) / (maxYear - minYear)) * 100;
    percent = Math.max(0, Math.min(100, percent)); 
    
    const type = normalizeType(songInfo.type);
    
    let dotColor = '#D1D5DB'; 
    if (type === 'è¡¨é¡Œæ›²') dotColor = '#FF69B4'; 
    else if (type === 'ã‚«ãƒƒãƒ—ãƒªãƒ³ã‚°æ›²') dotColor = '#3B82F6'; 
    else if (type === 'ã‚¢ãƒ«ãƒãƒ æ›²') dotColor = '#EAB308'; 
    
    return `
      <div class="timeline-container" onclick="this.querySelector('.timeline-dot').classList.toggle('active'); event.stopPropagation();">
        <div class="timeline-bar">
          <div class="timeline-dot" style="left: ${percent}%; background-color: ${dotColor};">
            <div class="year-tooltip">${songYear}</div>
          </div>
        </div>
      </div>
    `;
  }

  let setlistHtml = '', songNum = 1, inMedley = false, medleyNum = 1, encoreNum = 0;
  let typeCounts = { 'è¡¨é¡Œæ›²': 0, 'ã‚«ãƒƒãƒ—ãƒªãƒ³ã‚°æ›²': 0, 'ã‚¢ãƒ«ãƒãƒ æ›²': 0, 'ãã®ä»–': 0 };
  
  rec.setlist.forEach((s, idx) => {
    if (!s || !s.trim()) return;
    if (s === '__MEDLEY_END__') { inMedley = false; return; }
    if (s === '__MEDLEY_START__') {
      const nextSongIsEncore = idx + 1 < rec.setlist.length && rec.setlist[idx + 1].includes('_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«');
      if (nextSongIsEncore) {
        let currentEncore = rec.setlist[idx+1].includes('#3') ? 3 : rec.setlist[idx+1].includes('#2') ? 2 : 1;
        if (currentEncore > encoreNum) {
          encoreNum = currentEncore;
          setlistHtml += `<div class="setlist-encore-header">ã‚¢ãƒ³ã‚³ãƒ¼ãƒ« ${'ğŸ‘'.repeat(encoreNum)}</div>`;
        }
      }
      inMedley = true;
      setlistHtml += `<div class="setlist-item setlist-medley-title${nextSongIsEncore ? ' setlist-encore' : ''}" style="justify-content: flex-start;">
        <div class="setlist-left-content">
          <span class="setlist-item-number">${songNum++}.</span>
          <span class="setlist-item-title">ãƒ¡ãƒ‰ãƒ¬ãƒ¼</span>
        </div>
      </div>`;
      medleyNum = 1;
      return;
    }

    const cleanSong = s.replace(/_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«(?: #\d+)?/g, '').trim();
    
    const songInfo = songData[cleanSong];
    if (songInfo) {
      const normalizedType = normalizeType(songInfo.type);
      if (typeCounts[normalizedType] !== undefined) {
        typeCounts[normalizedType]++;
      } else {
        typeCounts['ãã®ä»–']++;
      }
    }

    let currentEncore = s.includes('_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«') ? (s.includes('#3') ? 3 : s.includes('#2') ? 2 : 1) : 0;
    if (currentEncore > encoreNum && !inMedley) {
      encoreNum = currentEncore;
      setlistHtml += `<div class="setlist-encore-header">ã‚¢ãƒ³ã‚³ãƒ¼ãƒ« ${'ğŸ‘'.repeat(encoreNum)}</div>`;
    }

    const timeline = createTimelineHtml(cleanSong);

    setlistHtml += `
      <div class="setlist-item${inMedley ? ' setlist-medley' : ''}${currentEncore > 0 ? ' setlist-encore' : ''}">
        <div class="setlist-left-content">
          <span class="setlist-item-number">${inMedley ? `(${medleyNum++})` : `${songNum++}.`}</span>
          <span class="setlist-item-title">${cleanSong}</span>
        </div>
        ${timeline}
      </div>`;
  });

  const legendHtml = `
    <div class="flex flex-col items-end justify-end pb-1">
      <div class="text-[10px] text-gray-400 leading-none mb-1 text-center w-full">ãƒªãƒªãƒ¼ã‚¹å¹´</div>
      <div class="flex items-center text-[10px] text-gray-400 leading-none">
        <span class="mr-1">1998</span>
        <div class="w-20 h-[1px] bg-gray-300 mx-1 relative flex items-center justify-center">
            <div class="w-2 h-2 rounded-full shadow-sm" style="background-color: var(--aiko-pink);"></div>
        </div>
        <span class="ml-1">${maxYear}</span>
      </div>
    </div>`;

  const summaryHtml = `
    <div class="mt-6 p-4 bg-gray-50 rounded-lg text-sm text-gray-600 font-bold text-center border border-gray-100">
      <div class="mb-1">ğŸ“Š ã“ã®ãƒ©ã‚¤ãƒ–ã®æˆåˆ†è¡¨</div>
      <span class="text-aiko-pink">è¡¨é¡Œæ›²: ${typeCounts['è¡¨é¡Œæ›²']}</span> / 
      <span class="text-blue-500">ã‚«ãƒƒãƒ—ãƒªãƒ³ã‚°: ${typeCounts['ã‚«ãƒƒãƒ—ãƒªãƒ³ã‚°æ›²']}</span> / 
      <span class="text-yellow-500">ã‚¢ãƒ«ãƒãƒ : ${typeCounts['ã‚¢ãƒ«ãƒãƒ æ›²']}</span>
    </div>
  `;

  const setlistHeaderHtml = `
    <div class="flex justify-between items-end mt-8 mb-2">
       <h3 class="font-bold text-gray-700 text-lg cursor-pointer flex items-center gap-2" onclick="copySetlist()">ğŸµ ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ</h3>
       ${legendHtml}
    </div>
  `;

  const setlistSection = setlistHtml.trim()
    ? `
       ${summaryHtml}
       ${setlistHeaderHtml}
       <div class="card-base shadow-none border border-gray-100 pb-2">
         ${setlistHtml}
       </div>`
    : `<h3 class="font-bold mb-3 text-gray-700 text-lg">ğŸµ ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ</h3><div class="card-base text-gray-500 text-sm leading-relaxed">ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚’çŸ¥ã£ã¦ã„ã‚‹æ–¹ãŒã„ã¾ã—ãŸã‚‰ã€ã‚ˆã‹ã£ãŸã‚‰ãœã²X(Twitter)ã®<a href="https://twitter.com/noki_dochibi" target="_blank" class="text-blue-500 underline">@noki_dochibi</a>ã¾ã§æ•™ãˆã¦ãã ã•ã„ã€‚</div>`;

  detailContainer.innerHTML = `
    <div id="detail-header-area" class="pt-2 -mt-2 cursor-pointer">
      <h2 class="font-extrabold mb-2 text-aiko-pink text-2xl leading-tight">${rec.tourName}</h2>
    </div>
    <div class="card-base mb-6 bg-white">
      <p class="text-gray-500 text-xs font-semibold mb-1">é–‹å‚¬æ—¥</p><p class="font-bold text-lg text-gray-800">${rec.date} (${rec.dayOfWeek})</p>
      <div class="border-t my-3 border-gray-100"></div>
      <p class="text-gray-500 text-xs font-semibold mb-1">ä¼šå ´</p><p class="font-bold text-lg text-gray-800">${rec.venue} (${rec.region})</p>
    </div>
    ${setlistSection}
    <p class="text-center text-gray-400 mt-8 text-xs">â€»æ³¨:ä»Šã¾ã•ã«ã‚ãªãŸãŒè¦‹ã¦ã„ã‚‹ã‚»ãƒˆãƒª é–“é•ã„ã˜ã‚ƒãªã„ã¨ã¯è¨€ã„åˆ‡ã‚Œãªã„ğŸŒ¸</p>`;

  document.getElementById('detail-header-area').onclick = hideDetailView;
  document.getElementById('app').scrollTop = 0;
}

function hideDetailView() {
  document.body.classList.remove('detail-view');
  document.getElementById('live-detail').style.display = 'none';
  document.getElementById('back-button-fixed').style.display = 'none';
  document.getElementById('main-header').style.display = 'flex';
  document.querySelector('nav').style.display = 'flex';
  switchToTab(document.querySelector('.tab-item.active').dataset.tab);
  currentDisplayingRecord = null;
}

function copySetlist() {
  if (!currentDisplayingRecord) return;
  if (!confirm('ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã‹ï¼Ÿ')) return;

  let text = '';
  // Setlist formatter logic for copy
  let songNum = 1;
  let medleyNum = 1;
  let inMedley = false;
  
  currentDisplayingRecord.setlist.forEach((s) => {
    if (s === '__MEDLEY_START__') {
        text += `${songNum++}. ãƒ¡ãƒ‰ãƒ¬ãƒ¼\n`;
        inMedley = true;
        medleyNum = 1;
        return;
    }
    if (s === '__MEDLEY_END__') {
        inMedley = false;
        return;
    }

    const cleanName = s.replace(/_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«(?: #\d+)?/g, '').trim();
    
    if (inMedley) {
        text += `  (${medleyNum++}) ${cleanName}\n`;
    } else {
        text += `${songNum++}. ${cleanName}\n`;
    }
  });
    
  navigator.clipboard.writeText(text).then(() => {
      alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
  }).catch(err => {
      console.error(err);
      alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
  });
}

function searchVenue(venue) {
  ['tour-select', 'year-select', 'region-select', 'song-filter-input'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('search-input').value = venue;
  switchToTab('search');
  applyFilters();
}

function searchRegion(region) {
  ['search-input', 'tour-select', 'year-select', 'song-filter-input'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('region-select').value = region;
  switchToTab('search');
  applyFilters();
}

function selectSong(songName) {
  document.getElementById('song-search-input').value = songName;
  // æ¥½æ›²ã‚¿ãƒ–ã¸ç§»å‹•ã—ã¦ã‹ã‚‰ãƒ©ãƒ³ã‚­ãƒ³ã‚°æç”»
  switchToTab('song'); 
  renderSongRanking();
  renderLiveCountChart();
  document.getElementById('show-setlist-btn').style.display = 'inline-block';
}

function selectVenue(fullVenueName) {
  selectedVenueInfo = { type: 'venue', name: fullVenueName };
  document.getElementById('venue-search-input').value = fullVenueName;
  // å ´æ‰€ã‚¿ãƒ–ã¸ç§»å‹•
  switchToTab('venue');
  // æ˜ç¤ºçš„ã«ä¼šå ´ã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
  document.querySelectorAll('.venue-tab').forEach(t => t.classList.remove('active'));
  document.querySelector('.venue-tab[data-venue-tab="venue"]').classList.add('active');
  document.getElementById('venue-ranking-container').style.display = 'block';
  document.getElementById('region-ranking-container').style.display = 'none';
  
  renderVenueRanking();
  renderVenueLiveCountChart();
  document.getElementById('venue-show-setlist-btn').style.display = 'inline-block';
}

function selectRegion(regionName) {
  selectedVenueInfo = { type: 'region', name: regionName };
  document.getElementById('venue-search-input').value = regionName;
  switchToTab('venue');
  // æ˜ç¤ºçš„ã«éƒ½é“åºœçœŒã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
  document.querySelectorAll('.venue-tab').forEach(t => t.classList.remove('active'));
  document.querySelector('.venue-tab[data-venue-tab="region"]').classList.add('active');
  document.getElementById('venue-ranking-container').style.display = 'none';
  document.getElementById('region-ranking-container').style.display = 'block';

  renderVenueRanking();
  renderVenueLiveCountChart();
  document.getElementById('venue-show-setlist-btn').style.display = 'inline-block';
}

function switchToTab(tabId) {
  document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab-item[data-tab="${tabId}"]`).classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
  document.getElementById(`tab-${tabId}`).style.display = 'block';
  document.getElementById('app').scrollTop = 0;
  lucide.createIcons();

  if (tabId === 'song') {
    if(chartInstances.liveCount) chartInstances.liveCount.resize();
  }
  if (tabId === 'pattern') {
    renderAlbumChart();
  }
  if (tabId === 'venue' && chartInstances.venueLiveCount) {
    chartInstances.venueLiveCount.resize();
  }
}

function renderSongRanking() {
  const container = document.getElementById('song-ranking-container');
  if (!container) return;
  const sortOrder = document.getElementById('song-sort').value;
  const searchTerm = document.getElementById('song-search-input').value.toLowerCase();
  
  // ãƒˆã‚°ãƒ«ã®çŠ¶æ…‹ã‚’ç¢ºèª
  const isMedleyIncluded = document.getElementById('medley-toggle').checked;
  const targetStats = isMedleyIncluded ? songStats : songStatsNoMedley;

  const sortedSongs = Object.entries(targetStats)
    .filter(([song]) => song.toLowerCase().startsWith(searchTerm))
    .map(([song, count]) => ({ song, count }))
    .sort((a, b) => sortOrder === 'count-desc' ? b.count - a.count : a.count - b.count);

  document.getElementById('total-songs').textContent = Object.keys(songStats).length;
  
  let currentRank = 0;
  let lastCount = -1;
  let skip = 1;

  container.innerHTML = sortedSongs.map((item, index) => {
    if (item.count !== lastCount) {
        if (lastCount !== -1) {
            currentRank += skip;
            skip = 1;
        } else {
            currentRank = 1;
        }
        lastCount = item.count;
    } else {
        skip++;
    }

    const rankColor = currentRank <= 3 && searchTerm === '' ? ['text-aiko-pink','text-aiko-yellow','text-aiko-blue'][currentRank-1] : 'text-gray-300';
    return `
      <div class="card-base p-3 mb-2 clickable-item flex items-center border border-gray-100" onclick="selectSong('${item.song.replace(/'/g, "\\'")}')">
        <span class="rank-number ${rankColor}">${currentRank}</span>
        <span class="song-title text-gray-700">${item.song}</span>
        <span class="song-count">${item.count} <span>å›</span></span>
      </div>`}).join('');
}

function renderPatternStats() {
  const types = ['opening', 'encore', 'last'];
  types.forEach(type => {
    const container = document.getElementById(type + '-songs');
    if (!container) return;
    const data = Object.entries(patternStats[type + 'Songs']).sort((a, b) => b[1] - a[1]).slice(0, 10);
    container.innerHTML = data.map(([song, count], i) => {
      const rankColor = i < 3 ? ['text-aiko-pink','text-aiko-yellow','text-aiko-blue'][i] : 'text-gray-300';
      const borderClass = i !== data.length -1 ? 'border-b border-gray-100' : '';
      return `<div class="p-3 clickable-item flex items-center ${borderClass}" onclick="showModal('${song.replace(/'/g, "\\'")}', '${type}')">
        <span class="rank-number ${rankColor}">${i + 1}</span>
        <span class="song-title text-gray-700">${song}</span>
        <span class="song-count">${count} <span>å›</span></span>
      </div>`
    }).join('');
  });
}

function renderVenueRanking() {
  const venueContainer = document.getElementById('venue-ranking-container');
  const regionContainer = document.getElementById('region-ranking-container');
  if (!venueContainer || !regionContainer) return;

  const vcs = {}, rcs = {};
  allLiveRecords.forEach(rec => {
    const venueKey = rec.region === 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' ? 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' : `${rec.venue} (${rec.region})`;
    vcs[venueKey] = (vcs[venueKey] || 0) + 1;
    if (rec.region) rcs[rec.region] = (rcs[rec.region] || 0) + 1;
  });

  const searchTerm = document.getElementById('venue-search-input').value.toLowerCase();
  const rankColors = ['text-aiko-pink', 'text-aiko-yellow', 'text-aiko-blue'];

  const filteredVenues = Object.entries(vcs)
    .filter(([name]) => name.toLowerCase().includes(searchTerm))
    .sort((a, b) => b[1] - a[1]);

  venueContainer.innerHTML = filteredVenues.map(([name, count], i) => `
    <div class="card-base p-3 mb-2 clickable-item flex items-center border border-gray-100" onclick="selectVenue('${name.replace(/'/g, "\\'")}')">
      <span class="rank-number ${i < 3 && searchTerm === '' ? rankColors[i] : 'text-gray-300'}">${filteredVenues.findIndex(v => v[0] === name) + 1}</span>
      <span class="venue-name text-gray-700">${name}</span>
      <span class="song-count">${count} <span>å›</span></span>
    </div>`).join('');

  const filteredRegions = Object.entries(rcs)
    .filter(([name]) => name.toLowerCase().includes(searchTerm))
    .sort((a, b) => b[1] - a[1]);

  let regionHtml = filteredRegions.map(([name, count], i) => `
    <div class="card-base p-3 mb-2 clickable-item flex items-center border border-gray-100" onclick="selectRegion('${name.replace(/'/g, "\\'")}')">
      <span class="rank-number ${i < 3 && searchTerm === '' ? rankColors[i] : 'text-gray-300'}">${filteredRegions.findIndex(r => r[0] === name) + 1}</span>
      <span class="venue-name text-gray-700">${name}</span>
      <span class="song-count">${count} <span>å›</span></span>
    </div>`).join('');

  if (searchTerm === '') {
    const allRegions = ['åŒ—æµ·é“','é’æ£®çœŒ','å²©æ‰‹çœŒ','å®®åŸçœŒ','ç§‹ç”°çœŒ','å±±å½¢çœŒ','ç¦å³¶çœŒ','èŒ¨åŸçœŒ','æ ƒæœ¨çœŒ','ç¾¤é¦¬çœŒ','åŸ¼ç‰çœŒ','åƒè‘‰çœŒ','æ±äº¬éƒ½','ç¥å¥ˆå·çœŒ','æ–°æ½ŸçœŒ','å¯Œå±±çœŒ','çŸ³å·çœŒ','ç¦äº•çœŒ','å±±æ¢¨çœŒ','é•·é‡çœŒ','å²é˜œçœŒ','é™å²¡çœŒ','æ„›çŸ¥çœŒ','ä¸‰é‡çœŒ','æ»‹è³€çœŒ','äº¬éƒ½åºœ','å¤§é˜ªåºœ','å…µåº«çœŒ','å¥ˆè‰¯çœŒ','å’Œæ­Œå±±çœŒ','é³¥å–çœŒ','å³¶æ ¹çœŒ','å²¡å±±çœŒ','åºƒå³¶çœŒ','å±±å£çœŒ','å¾³å³¶çœŒ','é¦™å·çœŒ','æ„›åª›çœŒ','é«˜çŸ¥çœŒ','ç¦å²¡çœŒ','ä½è³€çœŒ','é•·å´çœŒ','ç†Šæœ¬çœŒ','å¤§åˆ†çœŒ','å®®å´çœŒ','é¹¿å…å³¶çœŒ','æ²–ç¸„çœŒ'];
    const heldRegions = new Set(Object.keys(rcs));
    const zeroRegions = allRegions.filter(r => !heldRegions.has(r));
    if (zeroRegions.length > 0) {
      regionHtml += '<div class="mt-6 mb-3 px-1"><h4 class="font-bold text-gray-500 text-sm">é–‹å‚¬ãªã—</h4></div>';
      regionHtml += zeroRegions.sort().map(region =>
        `<div class="card-base p-3 mb-2 flex items-center opacity-50 bg-gray-50 border border-gray-100">
          <span class="rank-number text-gray-300 text-sm" style="min-width:30px;">-</span>
          <span class="venue-name text-gray-500">${region}</span>
          <span class="song-count text-gray-400">0 <span>å›</span></span>
        </div>`
      ).join('');
    }
  }
  regionContainer.innerHTML = regionHtml;
}

function setupEventListeners() {
  ['search-input', 'tour-select', 'year-select', 'region-select', 'song-filter-input'].forEach(id => {
    document.getElementById(id).addEventListener(id.includes('select') ? 'change' : 'input', applyFilters);
  });

  document.getElementById('clear-all-btn').addEventListener('click', () => {
    ['search-input', 'tour-select', 'year-select', 'region-select'].forEach(id => document.getElementById(id).value = '');
    const songInput = document.getElementById('song-filter-input');
    songInput.value = '';
    songInput.placeholder = 'æ›²åã§çµã‚Šè¾¼ã¿ï¼ˆæ¥½æ›²ã‚¿ãƒ–ã§é¸æŠï¼‰';
    applyFilters();
  });

  document.getElementById('song-search-input').addEventListener('input', () => {
    renderSongRanking();
    document.getElementById('show-setlist-btn').style.display = 'none';
  });
  document.getElementById('song-sort').addEventListener('change', renderSongRanking);
  document.getElementById('song-clear-btn').addEventListener('click', () => {
    document.getElementById('song-search-input').value = '';
    renderSongRanking();
    renderLiveCountChart();
    document.getElementById('show-setlist-btn').style.display = 'none';
  });

  // ãƒ¡ãƒ‰ãƒ¬ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒˆã‚°ãƒ«
  document.getElementById('medley-toggle').addEventListener('change', () => {
      // ãƒ©ãƒ³ã‚­ãƒ³ã‚°å†æç”»
      renderSongRanking();
      // ã‚°ãƒ©ãƒ•ã‚‚å†æç”»
      renderLiveCountChart();
  });

  document.getElementById('show-setlist-btn').addEventListener('click', () => {
    const songName = document.getElementById('song-search-input').value;
    if (songName) {
      const songInput = document.getElementById('song-filter-input');
      songInput.value = `${songName}ï¼ˆæ¥½æ›²ã‚¿ãƒ–ã‹ã‚‰é¸æŠï¼‰`;
      switchToTab('search');
      applyFilters();
    }
  });

  document.getElementById('venue-search-input').addEventListener('input', renderVenueRanking);
  document.getElementById('venue-clear-btn').addEventListener('click', () => {
    document.getElementById('venue-search-input').value = '';
    selectedVenueInfo = null;
    document.getElementById('venue-show-setlist-btn').style.display = 'none';
    renderVenueRanking();
    renderVenueLiveCountChart();
  });

  document.getElementById('venue-show-setlist-btn').addEventListener('click', () => {
    if (!selectedVenueInfo) return;
    if (selectedVenueInfo.type === 'venue') {
      const venueOnlyName = selectedVenueInfo.name.split(' (')[0];
      searchVenue(venueOnlyName);
    } else if (selectedVenueInfo.type === 'region') {
      searchRegion(selectedVenueInfo.name);
    }
  });

  document.querySelectorAll('.venue-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.venue-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const isVenue = tab.dataset.venueTab === 'venue';
      document.getElementById('venue-ranking-container').style.display = isVenue ? 'block' : 'none';
      document.getElementById('region-ranking-container').style.display = isVenue ? 'none' : 'block';
    });
  });

  document.querySelectorAll('.tab-item').forEach(tab => {
    tab.addEventListener('click', e => { e.preventDefault(); switchToTab(tab.dataset.tab); });
  });

  document.getElementById('info-btn').addEventListener('click', () => document.getElementById('info-modal').style.display = 'flex');
  [document.getElementById('modal-overlay'), document.getElementById('info-modal')].forEach(modal => {
    modal.addEventListener('click', e => { if (e.target === e.currentTarget) e.target.style.display = 'none'; });
  });
  document.getElementById('main-header').addEventListener('click', e => {
    if (!e.target.closest('#info-btn')) document.getElementById('app').scrollTo({ top: 0, behavior: 'smooth' });
  });
}

function handleError(error) {
  console.error("API Error:", error);
  document.getElementById('live-list-container').innerHTML = `<p class="text-center text-red-500 py-8 text-sm">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br>(${error.message})</p>`;
}

function showModal(song, type) {
  const matchedRecords = [];
  allLiveRecords.forEach(rec => {
    const cleanSetlist = rec.setlist.filter(s => !s.startsWith('__MEDLEY_')).map(s => s.replace(/_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«/g, '').replace(/#\d+$/g, '').trim());
    let isMatch = false;
    if (type === 'opening' && cleanSetlist[0] === song) isMatch = true;
    else if (type === 'last' && cleanSetlist[cleanSetlist.length - 1] === song) isMatch = true;
    else if (type === 'encore' && rec.setlist.some(s => s.includes('_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«') && s.replace(/_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«/g, '').replace(/#\d+$/g, '').trim() === song)) isMatch = true;
    if (isMatch) matchedRecords.push(rec);
  });

  matchedRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
  const matches = new Set(matchedRecords.map(r => r.tourName));

  const top5 = Array.from(matches).slice(0, 5);
  let html = `<h2 class="font-bold mb-4 text-aiko-pink text-2xl">${song}</h2><div class="text-base text-gray-700">`;
  html += top5.map(m => `<p class="mb-2">ãƒ»${m}</p>`).join('');
  if (matches.size > 5) html += `<p class="mt-4 text-gray-400 text-sm">ãªã©ã€è¨ˆ${matches.size}å…¬æ¼”</p>`;
  html += '</div>';
  document.getElementById('modal-body').innerHTML = html;
  document.getElementById('modal-overlay').style.display = 'flex';
}

function closeModal() {
  document.getElementById('modal-overlay').style.display = 'none';
}

function closeInfoModal() {
  document.getElementById('info-modal').style.display = 'none';
}
</script>
</body>
</html>
